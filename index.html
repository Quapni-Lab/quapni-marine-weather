<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ°£å€™è³‡è¨Š</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f0f0f; --text:#fff; --muted:rgba(255,255,255,.6);
  --accent:#ffcc9a; --cardTop:#2b2b2b; --cardBottom:#8a8a8a;
  --divider:rgba(255,255,255,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  display:flex;justify-content:center;align-items:flex-start;padding:16px;
}
/* ç‰ˆå¿ƒèˆ‡ç¶²æ ¼ -----------------------------------------------------------------*/
.container{width:412px;padding-bottom:160px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
/* å¡ç‰‡ -----------------------------------------------------------------------*/
.card{
  border-radius:20px;background:linear-gradient(180deg,var(--cardTop),var(--cardBottom));
  padding:14px 16px 16px;box-shadow:0 4px 10px rgba(0,0,0,.25);
  display:flex;flex-direction:column;min-height:170px;
}
.header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.header-left{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px;}
.header-left img{width:16px;height:16px;object-fit:contain;}
.chev{color:rgba(255,255,255,.55);font-size:18px;line-height:1;}
.hint{margin-top:6px;color:var(--accent);font-size:11px;}
.main{margin-top:6px;font-size:32px;line-height:1;letter-spacing:.2px;min-height:38px;}
.kvlist{margin-top:10px;border-top:1px solid var(--divider);padding-top:8px;}
.kv{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin:6px 0;}
.kv .left{display:flex;align-items:center;gap:8px;}
.kv .left img{width:14px;height:14px;object-fit:contain;opacity:.9;}
.kv .label{color:var(--muted);}
.kv .value{color:#fff;}
.value.neg{color:#7ec7ff;}.value.pos{color:#78e3cf;}

/* Fish card */
.card.fish{grid-column:1 / span 2;padding:16px 18px;min-height:auto;}
.fish .title{font-weight:600;letter-spacing:.3px;}
.fish .sub{margin-top:4px;color:var(--accent);font-size:11px;}
.fish .row{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  gap:12px;
}
.fish .period{text-align:center;line-height:1.35}
.fish .period .muted{color:rgba(255,255,255,.55);display:block;font-size:11px;margin-bottom:4px;}
.fish .period .time{font-size:12px;letter-spacing:.2px;}
.fish .dialwrap{position:relative;width:168px;height:168px;margin:0 auto;}
.fish object.dial{width:100%;height:100%;display:block;border:0;}

/* Weather card --------------------------------------------------------------*/
.weather .topline{display:flex;align-items:center;gap:10px;margin-top:6px;}
.weather .now{font-size:32px;}
.weather .icon{width:28px;height:28px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;}
.weather .icon img{width:100%;height:100%;object-fit:contain;display:block;}
.weather .hi-lo{font-size:11px;opacity:.85;line-height:1.15;}
/* Wave card -----------------------------------------------------------------*/
.wave .main{margin-bottom:2px;}
/* Wind card -----------------------------------------------------------------*/
.wind .dialwrap{margin-top:6px;position:relative;height:150px;}
.wind .rose{position:absolute;left:50%;top:0;transform:translateX(-50%);width:150px;height:150px;object-fit:contain;}
.wind .center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.35;}
.wind .center .lvl{font-size:16px;}
.wind .center .spd,.wind .center .dir{font-size:12px;}
/* UV ------------------------------------------------------------------------*/
.uv .uvbar{margin-top:8px;height:12px;border-radius:999px;background:linear-gradient(90deg,#fa6161,#d545fd);position:relative;overflow:hidden;}
.uv .uvbar .pin{position:absolute;left:6px;top:50%;transform:translateY(-50%);width:8px;height:8px;background:#fff;border-radius:50%;}
/* Pressure ------------------------------------------------------------------*/
.pressure .dialwrap{margin-top:6px;position:relative;height:120px;}
.pressure .gauge{position:absolute;left:50%;top:10px;transform:translateX(-50%);width:140px;height:96px;object-fit:contain;}
.pressure .read{position:absolute;left:0;right:0;top:40px;display:flex;flex-direction:column;align-items:center;gap:3px;}
.pressure .read .num{font-size:28px;}
.pressure .range{position:absolute;left:26px;right:26px;bottom:8px;display:flex;justify-content:space-between;font-size:11px;}
/* Moon ----------------------------------------------------------------------*/
.moon .moon-row{display:flex;align-items:center;gap:12px;margin-top:10px;}
.moon .moon-emoji{width:45px;height:45px;display:flex;align-items:center;justify-content:center;font-size:44px;line-height:1;}
.moon .stats{display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.35;}
.moon .stat-row{display:flex;align-items:center;gap:8px;}
.moon .stat-row img{width:14px;height:14px;object-fit:contain;opacity:.9;}
.moon .stat-row .label{color:var(--muted);}
/* Navbar --------------------------------------------------------------------*/
.navbar{
  position:fixed;left:50%;bottom:0;transform:translateX(-50%);
  width:412px;max-width:100vw;height:76px;z-index:50;
  background:#000;border-top:1px solid var(--divider);
  box-shadow:0 -6px 16px rgba(0,0,0,.35);padding-bottom:env(safe-area-inset-bottom);
}
.navbar .nav-inner{height:76px;display:flex;align-items:center;justify-content:space-between;padding:0 31px;}
.nav-item{width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;opacity:.6;background:none;border:0;padding:0;cursor:pointer;}
.nav-item img{width:30px;height:30px;object-fit:contain;display:block;}
.nav-item.active{opacity:1;filter:drop-shadow(0 2px 0 rgba(12,0,247,.15));}
/* Loc chip -----------------------------------------------------*/
.loc-chip{
  position:fixed;left:50%;bottom:96px;transform:translateX(-50%) translateY(20px);
  width:calc(100% - 48px);max-width:412px;z-index:60;
  display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
  background:rgba(0,0,0,.8);box-shadow:0 8px 24px rgba(0,0,0,.35);
  opacity:0;pointer-events:none;transition:.25s ease;
}
.loc-chip.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto;}
.loc-chip .left-ico{width:18px;height:18px;flex:0 0 auto;}
.loc-chip .right-btn{width:28px;height:28px;flex:0 0 auto;border-radius:999px;border:none;cursor:pointer;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;}
.loc-chip .right-btn img{width:18px;height:18px;}
.loc-chip .text{flex:1;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* Bottom sheet -------------------------------------------------*/
.sheet-mask{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:70;opacity:0;pointer-events:none;transition:.25s ease;}
.sheet-mask.show{opacity:1;pointer-events:auto;}
.sheet{
  position:fixed;left:50%;bottom:0;transform:translateX(-50%) translateY(100%);
  width:412px;max-width:100vw;z-index:75;background:linear-gradient(180deg,#2b2b2b,#8a8a8a);
  border-radius:20px 20px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.4);
  padding:14px 16px 24px;transition:.35s ease;
}
.sheet.show{transform:translateX(-50%) translateY(0);}
.sheet .sheet-header{display:flex;align-items:center;justify-content:space-between;}
.sheet .title{font-weight:600;}
.sheet .close{background:none;border:0;color:#fff;font-size:20px;cursor:pointer;opacity:.8;}
.sheet .search{margin:10px 0 12px;}
.sheet .search input{width:100%;height:36px;border-radius:10px;border:1px solid var(--divider);background:rgba(0,0,0,.25);color:#fff;padding:0 10px;outline:none;}
.sheet ul{list-style:none;padding:0;margin:0;max-height:40vh;overflow:auto;}
.sheet li{display:flex;align-items:center;gap:10px;padding:10px 6px;border-bottom:1px solid var(--divider);cursor:pointer;}
.sheet li:hover{background:rgba(0,0,0,.15);}
.sheet li img{width:16px;height:16px;}
@media(max-width:420px){
  .container{width:100%;max-width:412px;}
  .grid{grid-template-columns:1fr;}
  .card.fish{grid-column:auto;}
  .navbar{width:100%;max-width:412px;}
}
</style>
</head>
<body>
<div class="container">
  <div class="grid">

    <!-- é­šå…’æ´»èºæŒ‡æ•¸ --------------------------------------------------------->
    <section class="card fish">
      <div class="header"><div class="title">é­šå…’æ´»èºæŒ‡æ•¸</div><div class="chev">â€º</div></div>
      <div class="sub" id="fish-hint">è‰¯å¥½ï¼é­šç¾¤æ´»èº</div>

      <div class="row">
        <!-- å·¦ï¼šä¸»è¦æ´»èºæœŸ -->
        <div class="period">
          <span class="muted">ä¸»è¦æ´»èºæœŸ</span>
          <div class="time">AM 7:31 â€” AM 10:01</div>
        </div>

        <!-- ä¸­ï¼šåœ“å½¢ SVG éŒ¶ç›¤ -->
        <div class="dialwrap" aria-label="é­šå…’æ´»èºæŒ‡æ•¸éŒ¶ç›¤">
          <object id="fishDial" class="dial" data="assets/images/image_dashboard_fishinIndex.svg" type="image/svg+xml"></object>
        </div>

        <!-- å³ï¼šæ¬¡ç´šæ´»èºæœŸ -->
        <div class="period">
          <span class="muted">æ¬¡ç´šæ´»èºæœŸ</span>
          <div class="time">AM 1:55 â€” AM 3:35</div>
        </div>
      </div>
    </section>

    <!-- æ½®æ±ï¼ˆopen-meteoï¼‰ --------------------------------------------------->
    <section class="card tide">
      <div class="header">
        <div class="header-left"><img src="assets/images/Icon_tide.png" alt=""><span>æ½®æ±</span></div>
        <div class="chev">â€º</div>
      </div>
      <div class="hint" id="tide-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="main"><span id="tide-current">--</span> <span style="font-size:18px;">m</span></div>
      <div class="kvlist">
        <div class="kv"><div class="left"><span class="label">ä¸‹æ¬¡ä¹¾æ½®æ™‚é–“</span></div><span class="value" id="tide-next-low-time">â€”</span></div>
        <div class="kv"><div class="left"><span class="label">ä¸‹æ¬¡ä¹¾æ½®é«˜åº¦</span></div><span class="value neg" id="tide-next-low-height">â€”</span></div>
        <div class="kv"><div class="left"><span class="label">ä¸‹æ¬¡æ»¿æ½®æ™‚é–“</span></div><span class="value" id="tide-next-high-time">â€”</span></div>
        <div class="kv"><div class="left"><span class="label">ä¸‹æ¬¡æ»¿æ½®é«˜åº¦</span></div><span class="value pos" id="tide-next-high-height">â€”</span></div>
      </div>
    </section>

    <!-- å¤©æ°£ ----------------------------------------------------------------->
    <section class="card weather" id="card-weather">
      <div class="header"><div class="header-left"><span>å¤©æ°£</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="weather-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="topline">
        <div class="now"><span id="temp-now">--</span>Â°</div>
        <div class="icon" id="weatherIcon" role="img" aria-label="å¤©æ°£åœ–ç¤º"></div>
        <div class="hi-lo">â†‘ <span id="temp-hi">--</span>Â°C<br>â†“ <span id="temp-lo">--</span>Â°C</div>
      </div>
      <div class="kvlist">
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_precipitation_probability.png" alt=""><span class="label">é™é›¨æ©Ÿç‡</span></div>
          <span class="value" id="precip-prob">--%</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_apparent_temperature.png" alt=""><span class="label">é«”æ„Ÿæº«åº¦</span></div>
          <span class="value"><span id="apparent">--</span>Â°</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_relative_humidity_2m.png" alt=""><span class="label">æ¿•åº¦</span></div>
          <span class="value" id="humidity">--%</span>
        </div>
      </div>
    </section>

    <!-- æµªæ³ ----------------------------------------------------------------->
    <section class="card wave" id="card-wave">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_wave.png" alt=""><span>æµªæ³</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="wave-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="main"><span id="wave-current">--</span> <span style="font-size:18px;">m/s</span></div>
      <div class="kvlist">
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wavetemperture.png" alt=""><span class="label">æµ·æ´‹æº«åº¦</span></div>
          <span class="value"><span id="sea-temp">--</span>Â°</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wavespeed.png" alt=""><span class="label">æµ·æµé€Ÿåº¦</span></div>
          <span class="value"><span id="current-speed">--</span> m/s</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wave_direction.png" alt=""><span class="label">æµªçš„æ–¹å‘</span></div>
          <span class="value" id="wave-dir">--</span>
        </div>
      </div>
    </section>

    <!-- é¢¨ ------------------------------------------------------------------->
    <section class="card wind" id="card-wind">
      <div class="header"><div class="header-left"><img src="assets/images/icon_wind.png" alt=""><span>é¢¨</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="wind-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="dialwrap">
        <object id="windRose" class="rose" data="assets/images/dashboardMockup_wind.svg" type="image/svg+xml"></object>
        <div class="center">
          <div class="lvl" id="wind-beaufort">â€”ç´š</div>
          <div class="spd" id="wind-speed">â€” å…¬é‡Œ/h</div>
          <div class="dir" id="wind-dir">â€”Â°</div>
        </div>
      </div>
    </section>

    <!-- ç´«å¤–ç·š --------------------------------------------------------------->
    <section class="card uv" id="card-uv">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_uv.png" alt=""><span>ç´«å¤–ç·š</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="uv-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="main" id="uv-index">0</div>
      <div class="uvbar"><span class="pin" id="uv-pin" aria-hidden="true"></span></div>
    </section>

    <!-- æ°£å£“ ----------------------------------------------------------------->
    <section class="card pressure" id="card-pressure">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_surface_pressure.png" alt="" style="width:14px;height:14px;"><span>æ°£å£“</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="press-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="dialwrap">
        <img class="gauge" src="assets/images/Dashboardmockup_surface_pressure.png" alt="">
        <div class="read">
          <div>â†“</div>
          <div class="num" id="pressure">â€”</div>
          <div style="font-size:12px;">ç™¾å¸•</div>
        </div>
        <div class="range"><span>ä½</span><span>é«˜</span></div>
      </div>
    </section>

    <!-- æœˆç›¸ --------------------------------------------------------------->
    <section class="card moon">
      <div class="header"><div class="header-left"><span id="moon-title">æœˆç›¸</span></div><div class="chev">â€º</div></div>
      <div class="hint" id="moon-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div class="moon-row">
        <div id="moonEmoji" class="moon-emoji" role="img" aria-label="æœˆç›¸">ğŸŒ˜</div>
        <div class="stats">
          <div class="stat-row">
            <img src="assets/images/Icon_birghtness.png" alt="">
            <span class="label">ç…§åº¦</span><span class="value" id="moon-illum">â€”%</span>
          </div>
          <div class="stat-row">
            <img src="assets/images/Icon_moonset.png" alt="">
            <span class="label" id="moon-rise-type">æœˆå‡º/æœˆè½</span><span class="value" id="moon-rise-set">â€”</span>
          </div>
          <div class="stat-row">
            <img src="assets/images/icon_fullMoon.png" alt="">
            <span class="label">ä¸‹æ¬¡æ»¿æœˆ</span><span class="value" id="moon-next-full">â€” å¤©</span>
          </div>
        </div>
      </div>
    </section>

    <!-- æ—¥è½ / æ—¥å‡º ----------------------------------------------------------->
    <section class="card" id="card-sun">
      <div class="header">
        <div class="header-left">
          <img src="assets/images/Icon_sun.png" alt="" style="width:16px;height:10px;">
          <span id="sun-header-label">æ—¥è½</span>
        </div>
        <div class="chev">â€º</div>
      </div>
      <div class="hint" id="sun-hint">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      <div style="margin-top:10px;display:flex;justify-content:center;">
        <img class="dial" src="assets/images/Dashboardmockup_sun.png" width="120" alt="">
      </div>
      <div id="sun-next-line" style="margin-top:8px;font-size:12px;">ä¸‹æ¬¡æ—¥å‡ºï¼š<span id="sun-next-time">â€”</span></div>
    </section>

  </div>
</div>

<!-- æ¼‚æµ®åœ°å€é¸æ“‡å™¨ ----------------------------------------------------------->
<div class="loc-chip" id="locChip" role="button" aria-label="é¸æ“‡åœ°å€">
  <img class="left-ico" src="assets/images/icon_selectable.png" alt="">
  <div class="text" id="locText">å®šä½ä¸­â€¦</div>
  <button class="right-btn" id="openSheetBtn" aria-label="é–‹å•Ÿåœ°å€é¸å–®">
    <img src="assets/images/icon_locationmain.png" alt="">
  </button>
</div>

<!-- åœ°é» Bottom Sheet --------------------------------------------------------->
<div class="sheet-mask" id="sheetMask"></div>
<section class="sheet" id="sheet">
  <div class="sheet-header">
    <div class="title">é¸æ“‡åœ°å€</div>
    <button class="close" id="sheetClose" aria-label="é—œé–‰">âœ•</button>
  </div>
  <div class="search"><input type="search" id="placeSearch" placeholder="æœå°‹åœ°é»æˆ–é—œéµå­—"></div>
  <ul id="placeList"></ul>
</section>

<!-- Navbar ------------------------------------------------------------------->
<nav class="navbar" role="navigation" aria-label="åº•éƒ¨å°è¦½">
  <div class="nav-inner">
    <button class="nav-item active" aria-label="ä»Šå¤©" data-nav="today"><img src="assets/images/Icon_nav_today.png" alt=""></button>
    <button class="nav-item" aria-label="é€±é å ±" data-nav="weekly"><img src="assets/images/Icon_nav_weeklypredict.png" alt=""></button>
    <button class="nav-item" aria-label="ç›¸æ©Ÿ" data-nav="camera"><img src="assets/images/Icon_nav_camera.png" alt=""></button>
    <button class="nav-item" aria-label="æˆ‘çš„ä½ç½®" data-nav="location" id="navLocation"><img src="assets/images/Icon_nav_mylocation.png" alt=""></button>
    <button class="nav-item" aria-label="è¨­å®š" data-nav="settings"><img src="assets/images/Icon_nav_setting.png" alt=""></button>
  </div>
</nav>

<script>
/* ========= é¢¨å‘å„€å‹•ç•« ===================================================== */
let currentNeedleAngle = 0;
function updateNeedle(angle){
  const svg = document.getElementById('windRose').contentDocument;
  if(!svg) return;
  svg.querySelectorAll('.st0').forEach(el=>{
    el.setAttribute('transform',`rotate(${(angle)%360} 100 100)`);
  });
}
function animateNeedle(target){
  const shortest=((target-currentNeedleAngle+540)%360)-180;
  const start=performance.now(),dur=800;
  const ease=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
  function step(now){
    const p=Math.min(1,(now-start)/dur);
    updateNeedle(currentNeedleAngle+shortest*ease(p));
    if(p<1)requestAnimationFrame(step);else currentNeedleAngle=target;
  }
  requestAnimationFrame(step);
}

/* ========= é­šå…’æ´»èºæŒ‡æ•¸ =================================================== */
/* ç°¡æ˜“è¨ˆç®—ï¼š0â€“100ï¼›é«˜â†’æ´»èº */
function calcFishIndex({waveH, windKmh, uvIdx, tideH}){
  let score = 100;
  if(waveH!=null) score -= Math.max(0,(waveH-0.5))*15;     // æµªé«˜å½±éŸ¿
  if(windKmh!=null) score -= Math.max(0,(windKmh-15))*1.2;  // å¼·é¢¨å½±éŸ¿
  if(uvIdx!=null) score -= Math.max(0,(uvIdx-5))*4;         // é«˜ç´«å¤–ç·š
  if(tideH!=null && tideH<0) score -= Math.abs(tideH)*8;    // ä¹¾æ½®
  return Math.round(Math.max(0,Math.min(100,score)));
}
function fishHintByIndex(i){
  if(i>=80) return 'æ¥µä½³ï¼å¤§é‡å’¬é¤Œ';
  if(i>=60) return 'è‰¯å¥½ï¼é­šç¾¤æ´»èº';
  if(i>=40) return 'æ™®é€šï¼Œéœ€è¦è€å¿ƒ';
  return 'è¼ƒå·®ï¼Œå’¬é¤Œç¨€å°‘';
}
function updateFishDial(val){
  const obj=document.getElementById('fishDial');
  const svg=obj?.contentDocument;
  if(!svg) return;
  const label=svg.getElementById('fish-index-label');
  if(label) label.textContent=val;
  /* è‹¥è¦åšç’°å½¢é€²åº¦æ¢ï¼Œå¯åœ¨æ­¤èª¿æ•´ progress-ring çš„ stroke-dasharray */
}

/* ========= Navbar Active æ¨™ç¤º ============================================= */
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* ========= LocChip æ»¾å‹•å½±è— ============================================== */
const locChip=document.getElementById('locChip');
let sheetOpen=false,lastY=window.scrollY;
locChip.classList.add('show');
window.addEventListener('scroll',()=>{
  if(sheetOpen)return;
  const y=window.scrollY;
  if(y>lastY)locChip.classList.remove('show');else if(y<lastY)locChip.classList.add('show');
  lastY=y;
},{passive:true});

/* ========= Bottom Sheet æ§åˆ¶ ============================================= */
const sheetMask=document.getElementById('sheetMask'),sheet=document.getElementById('sheet'),openSheetBtn=document.getElementById('openSheetBtn'),sheetClose=document.getElementById('sheetClose');
function openSheet(){sheetOpen=true;locChip.classList.add('show');sheet.classList.add('show');sheetMask.classList.add('show');}
function closeSheet(){sheetOpen=false;sheet.classList.remove('show');sheetMask.classList.remove('show');}
openSheetBtn.addEventListener('click',openSheet);
locChip.addEventListener('click',openSheet);
sheetMask.addEventListener('click',closeSheet);
sheetClose.addEventListener('click',closeSheet);

/* ========= åœ°é»æ¸…å–® ======================================================= */
const FAVORITES=[
  {name:'ä½¿ç”¨ç›®å‰ä½ç½®',useCurrent:true},
  {name:'æ¢§æ£²æ¼æ¸¯ï¼ˆå°ä¸­ï¼‰',lat:24.256,lon:120.508},
  {name:'åŸºéš†æ¸¯',lat:25.15,lon:121.75},
  {name:'æ·¡æ°´æ²³å‡ºæµ·å£',lat:25.17,lon:121.40},
  {name:'é¦¬å…¬æ¸¯ï¼ˆæ¾æ¹–ï¼‰',lat:23.566,lon:119.566}
];
const placeList=document.getElementById('placeList'),placeSearch=document.getElementById('placeSearch');
function renderList(kw=''){
  placeList.innerHTML='';
  FAVORITES.filter(p=>p.useCurrent||p.name.toLowerCase().includes(kw.toLowerCase())).forEach(p=>{
    const li=document.createElement('li');
    li.innerHTML=`<img src="assets/images/icon_selectable.png" alt=""><span>${p.name}</span>`;
    li.addEventListener('click',async()=>{
      closeSheet();
      const {lat,lon}=p.useCurrent?await getCoords():{lat:p.lat,lon:p.lon};
      await loadAll(lat,lon,true);
      await loadMoonUSNO(lat,lon);   // æ›´æ–°æœˆç›¸
      window.scrollTo({top:0,behavior:'smooth'});
    });
    placeList.appendChild(li);
  });
}
placeSearch.addEventListener('input',e=>renderList(e.target.value));
renderList();

/* ========= å·¥å…·å‡½å¼ï¼ˆæç¤ºè©å°æ‡‰ï¼‰ ======================================= */
const kmhToBeaufort=kmh=>[1,5,11,19,28,38,49,61,74,88,102,117,9999].findIndex(x=>kmh<=x);
const degToCompass=deg=>["åŒ—","åŒ—åŒ—æ±","æ±åŒ—","æ±åŒ—æ±","æ±","æ±å—æ±","æ±å—","å—å—æ±","å—","å—å—è¥¿","è¥¿å—","è¥¿å—è¥¿","è¥¿","è¥¿åŒ—è¥¿","è¥¿åŒ—","åŒ—åŒ—è¥¿"][Math.round(deg/22.5)%16];

const tideHintByHeight=h=>{
  const x=Math.max(0, h);
  if(x<=0.5) return 'æµ·ç˜ç¯„åœå¯¬ï¼Œé©åˆæ²¿å²¸èµ°èµ°';
  if(x<=1.5) return 'å²¸é‚Šæ´»å‹•èˆ’é©ï¼Œç•™æ„æµªèŠ±';
  if(x<=2.5) return 'å²¸é‚Šæ³¨æ„è…³ä¸‹å®‰å…¨';
  if(x<=3.5) return 'å»ºè­°ä¿æŒèˆ‡æ°´é‚Šé©ç•¶è·é›¢';
  return 'è«‹é¿å…ç«™åœ¨æµªæ‹æ‰“çš„å€åŸŸ';
};

const waveHintByHeight=h=>{
  if(h==null) return 'æµ·æ³æ›´æ–°ä¸­';
  if(h<=0.5) return 'æµ·é¢å¹³éœï¼Œé©åˆå²¸é‚Šæ•£æ­¥ã€‚';
  if(h<=1.0) return 'æµ·é¢å¾®æœ‰æ³¢å‹•ï¼Œå²¸é‚Šæ´»å‹•èˆ’é©ã€‚';
  if(h<=1.5) return 'æµªé«˜å¢åŠ ï¼Œç•™æ„å®‰å…¨ã€‚';
  if(h<=2.5) return 'æµªé«˜åé«˜ï¼Œå²¸é‚Šæ´»å‹•ä¿æŒè·é›¢ã€‚';
  return 'æµªå‹¢æ˜é¡¯ï¼Œé¿å…é è¿‘æµ·æµªæ‹æ‰“å€ã€‚';
};

const windHintByBeaufort=b=>{
  return [
    'å¹¾ä¹ç„¡é¢¨ï¼Œç©ºæ°£éœæ­¢',
    'å¾®é¢¨è¼•æ‹‚ï¼Œå¹¾ä¹æ„Ÿå—ä¸åˆ°',
    'å¾®é¢¨è¼•æŸ”ï¼Œè‘‰å­è¼•è¼•æ“ºå‹•',
    'å°é¢¨æ“¾å‹•ï¼Œæ¨¹æ¢¢å¾®å¾®æ“ºå‹•',
    'å¾®å¼·çš„é¢¨ï¼Œå°å¿ƒå¸½å­é£›èµ°',
    'ä¸­ç­‰å¼·é¢¨ï¼Œæ³¨æ„ä¿æš–é˜²è­·',
    'å¼·é¢¨ä¾†è¥²ï¼Œæˆ¶å¤–æ´»å‹•å°å¿ƒ',
    'çƒˆé¢¨æ˜é¡¯ï¼Œå¯èƒ½è¡Œèµ°å›°é›£',
    'çƒˆé¢¨å¢å¼·ï¼Œæˆ¶å¤–æ´»å‹•ä¸å»ºè­°',
    'è«‹å¾…åœ¨å®¤å…§ç¢ºä¿å®‰å…¨'
  ][Math.min(b,9)];
};

const uvHintByIndex=u=>{
  if(u<=2) return 'å¹¾ä¹ä¸ç”¨æ“”å¿ƒæ›¬å‚·';
  if(u<=5) return 'è¨˜å¾—æˆ´å¸½é˜²æ›¬';
  if(u<=7) return 'æ‡‰å¤šè£œæ“¦é˜²æ›¬';
  if(u<=10) return 'é˜²æ›¬è¡£ç‰©ä¸å¯å°‘';
  return 'å»ºè­°ç¸®çŸ­æˆ¶å¤–æ™‚é–“';
};

const pressureHintByHpa=p=>{
  if(p>1015) return 'å¤©æ°£ç©©å®šï¼Œé©åˆæˆ¶å¤–èµ°èµ°';
  if(p>=1005) return 'æ°£å£“å¹³è¡¡ï¼Œç©ºæ°£æ¸…çˆ½';
  return 'å¤©æ°£å¾®é™°ï¼Œç•™æ„èº«é«”ç‹€æ³';
};

const locText=document.getElementById('locText');
async function reverseGeocode(lat,lon){
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const j=await res.json();
    return j.display_name||`${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  }catch{return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;}
}
const getCoords=()=>new Promise(resolve=>{
  if(location.protocol==='https:'||location.hostname==='localhost'){
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat:pos.coords.latitude,lon:pos.coords.longitude}),
      async()=>{
        try{
          const ip=await fetch('https://ipapi.co/json/').then(r=>r.json());
          resolve({lat:ip.latitude,lon:ip.longitude});
        }catch{resolve({lat:24.256,lon:120.508});}
      },
      {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
    );
  }else{
    fetch('https://ipapi.co/json/').then(r=>r.json()).then(ip=>resolve({lat:ip.latitude,lon:ip.longitude})).catch(()=>resolve({lat:24.256,lon:120.508}));
  }
});

/* ========= æ™‚æ®µæç¤ºï¼ˆä¾é™„åœ–ï¼Œä¸é‡ç–Šåˆ†æ®µï¼‰ ================================ */
function getPeriodHint(date){
  const m = date.getHours()*60 + date.getMinutes();
  if (m < 240)   return 'æ·±å¤œå¯§éœï¼Œé©åˆæ€è€ƒæˆ–å…¥çœ ã€‚';
  if (m < 360)   return 'æ™¨æ›¦åˆç¾ï¼Œè¬ç‰©ç”¦é†’ã€‚';
  if (m < 480)   return 'å¤©å…‰ä¹ç¾ï¼Œæ–°çš„ä¸€å¤©é–‹å§‹ã€‚';
  if (m < 660)   return 'æœæ°£è“¬å‹ƒï¼Œæ˜¯æ´»å‹•çš„æ™‚æ®µã€‚';
  if (m < 780)   return 'æ—¥æ­£ç•¶ä¸­ï¼Œæº«åº¦é€æ¼¸å‡é«˜ã€‚';
  if (m < 960)   return 'åˆå¾Œæ™‚æ®µï¼Œé©åˆè¼•æ´»å‹•ã€‚';
  if (m < 1140)  return 'å¤•é™½è¥¿ä¸‹ï¼Œå…‰å½±æº«æŸ”ã€‚';
  return 'ç‡ˆç«åˆä¸Šï¼Œéœäº«å¤œè‰²ã€‚';
}

/* ========= WMO å°æ‡‰ï¼ˆåœ–ç¤º/æç¤ºï¼‰ ========================================= */
const WMO_ICON_MAP={0:{label:'Clear',slug:'clear'},1:{label:'Mostly Clear',slug:'mostly-clear'},2:{label:'Partly Cloudy',slug:'partly-cloudy'},3:{label:'Overcast',slug:'overcast'},45:{label:'Fog',slug:'fog'},48:{label:'Icy Fog',slug:'rime-fog'},51:{label:'Light Drizzle',slug:'light-drizzle'},53:{label:'Drizzle',slug:'moderate-drizzle'},55:{label:'Heavy Drizzle',slug:'dense-drizzle'},80:{label:'Light Showers',slug:'light-rain'},81:{label:'Showers',slug:'moderate-rain'},82:{label:'Heavy Showers',slug:'heavy-rain'},61:{label:'Light Rain',slug:'light-rain'},63:{label:'Rain',slug:'moderate-rain'},65:{label:'Heavy Rain',slug:'heavy-rain'},56:{label:'Light Freezing Drizzle',slug:'light-freezing-drizzle'},57:{label:'Freezing Drizzle',slug:'dense-freezing-drizzle'},66:{label:'Light Freezing Rain',slug:'light-freezing-rain'},67:{label:'Freezing Rain',slug:'heavy-freezing-rain'},71:{label:'Light Snow',slug:'slight-snowfall'},73:{label:'Snow',slug:'moderate-snowfall'},75:{label:'Heavy Snow',slug:'heavy-snowfall'},77:{label:'Snow Grains',slug:'snowflake'},85:{label:'Light Snow Showers',slug:'slight-snowfall'},86:{label:'Snow Showers',slug:'heavy-snowfall'},95:{label:'Thunderstorm',slug:'thunderstorm'},96:{label:'Light T-storm w/ Hail',slug:'thunderstorm-with-hail'},99:{label:'T-storm w/ Hail',slug:'thunderstorm-with-hail'}};
const AIRY_BASE='https://raw.githubusercontent.com/Leftium/weather-sense/refs/heads/main/static/icons/airy';
const EMOJI_FALLBACK={'clear':'â˜€ï¸','mostly-clear':'ğŸŒ¤ï¸','partly-cloudy':'â›…ï¸','overcast':'â˜ï¸','fog':'ğŸŒ«ï¸','rime-fog':'ğŸŒ«ï¸','light-drizzle':'ğŸŒ¦ï¸','moderate-drizzle':'ğŸŒ¦ï¸','dense-drizzle':'ğŸŒ§ï¸','light-rain':'ğŸŒ§ï¸','moderate-rain':'ğŸŒ§ï¸','heavy-rain':'ğŸŒ§ï¸','light-freezing-drizzle':'ğŸŒ¨ï¸','dense-freezing-drizzle':'ğŸŒ¨ï¸','light-freezing-rain':'ğŸŒ¨ï¸','heavy-freezing-rain':'ğŸŒ¨ï¸','slight-snowfall':'â„ï¸','moderate-snowfall':'â„ï¸','heavy-snowfall':'â„ï¸','snowflake':'â„ï¸','thunderstorm':'â›ˆï¸','thunderstorm-with-hail':'â›ˆï¸'};
function setWeatherIconByWMO(container,wmo){
  const rec=WMO_ICON_MAP[wmo]||{label:'Unknown',slug:'overcast'};
  const url=`${AIRY_BASE}/${rec.slug}@4x.png`;
  container.innerHTML='';
  const img=document.createElement('img');
  img.src=url; img.alt=rec.label; img.referrerPolicy='no-referrer';
  img.onerror=()=>{container.innerHTML=`<span style="font-size:18px;line-height:1">${EMOJI_FALLBACK[rec.slug]||'â“'}</span>`;};
  container.appendChild(img);
}
const WMO_HINT_ZH={0:'ä»Šå¤©å¤©æ°£æ™´æœ—å¿ƒæƒ…å¥½',1:'å¤©ç©ºå¤šé›²ä½†ä»èˆ’é©',2:'é™½å…‰èˆ‡é›²æœµäº¤éŒ¯',3:'é™°å¤©å‡ºé–€è¨˜å¾—å¸¶å¤–å¥—',45:'éœ§æ°£è¼ƒé‡ï¼Œè¡Œè»Šè«‹å°å¿ƒ',48:'éœœéœ§ä½èƒ½è¦‹åº¦ï¼Œæ³¨æ„å®‰å…¨',51:'æ¯›æ¯›é›¨ï¼Œå‡ºé–€å¸¶æŠŠå‚˜',53:'ç´°é›¨ç¶¿ç¶¿ï¼Œè¨˜å¾—é˜²æ°´',55:'å°é›¨åå¼·ï¼Œå¤–å‡ºè¦å‚™é›¨å…·',80:'çŸ­æš«é™£é›¨ï¼Œåˆ¥å¿˜äº†é›¨å‚˜',81:'é™£é›¨æ˜é¡¯ï¼Œè·¯é¢æ¿•æ»‘å°å¿ƒ',82:'å¼·é™£é›¨ï¼Œå¤–å‡ºè«‹å°å¿ƒ',61:'å°é›¨æ»´ç­”ï¼Œå¸¶ä»¶è–„å¤–å¥—',63:'ä¸­é›¨ä¾†è¨ªï¼Œè¡Œè»Šæ”¾æ…¢é€Ÿåº¦',65:'å¤§é›¨æ»‚æ²±ï¼Œç•™æ„ç©æ°´',56:'å°å†°éœ°ï¼å‡æ¯›é›¨ï¼Œè·¯é¢æ˜“æ»‘',57:'å‡æ¯›é›¨åå¼·ï¼Œæ³¨æ„çµå†°',66:'å°å‡é›¨ï¼Œè«‹å°å¿ƒè·¯æ»‘',67:'å‡é›¨è¼ƒå¼·ï¼Œç•¶å¿ƒçµå†°',71:'å°é›ªç´›é£›ï¼Œæ³¨æ„ä¿æš–',73:'ä¸­é›ªé£„è½ï¼Œå¤–å‡ºè«‹æ³¨æ„',75:'å¤§é›ªï¼æš´é›ªï¼Œäº¤é€šæå—å½±éŸ¿',77:'é›ªç²’é£„è½ï¼Œèƒ½è¦‹åº¦ç•¥é™',85:'å°é›ªé™£é›ªï¼Œé¢¨å¤§æ™‚æ›´å†·',86:'å¼·é™£é›ªï¼Œè¦–ç·šä¸ä½³',95:'é›·é›¨ç™¼å±•ï¼Œé é›¢ç©ºæ› èˆ‡æ¨¹ä¸‹',96:'é›·é›¨å¤¾é›¹ï¼Œå¾…åœ¨å®¤å…§è¼ƒå®‰å…¨',99:'å¼·é›·é›¨å¤¾é›¹ï¼Œå‹™å¿…æ³¨æ„å®‰å…¨'};

/* ========= æœˆç›¸ï¼ˆUSNOï¼‰ =================================================== */
// æœˆç›¸ä¸­æ–‡å­—
const zhPhase = {
  'New Moon':'æ–°æœˆ','Full Moon':'æ»¿æœˆ',
  'First Quarter':'ä¸Šå¼¦æœˆ','Last Quarter':'ä¸‹å¼¦æœˆ',
  'Waxing Crescent':'å³¨çœ‰æœˆ','Waning Crescent':'æ®˜æœˆ',
  'Waxing Gibbous':'ç›ˆå‡¸æœˆ','Waning Gibbous':'è™§å‡¸æœˆ'
};
// ä½ çš„æç¤ºèªï¼ˆä¾æœˆç›¸é¡¯ç¤ºï¼‰
const phaseHintZh = {
  'æ–°æœˆ':'é»‘å¤œç„¡å…‰ï¼Œå¤œç©ºé¡¯å¾—æ ¼å¤–å¯§éœ',
  'å³¨çœ‰æœˆ':'æœˆå…‰åˆç¾ï¼Œå¤©ç©ºé€å‡ºæº«æŸ”å…‰æšˆ',
  'ä¸Šå¼¦æœˆ':'åŠè¼ªæ˜æœˆï¼Œå¦‚åˆ‡å¦‚ç£‹',
  'ç›ˆå‡¸æœˆ':'æœˆè¼ªæ¼¸åœ“ï¼Œå…‰å½©æ¼¸æ˜',
  'æ»¿æœˆ':'æœˆè‰²çšæ½”ï¼Œè¬ç‰©æŸ“ä¸ŠéŠ€è¼',
  'è™§å‡¸æœˆ':'å…‰å½±é€€éš±ï¼Œå¤œæ™šæ¼¸æ·±',
  'ä¸‹å¼¦æœˆ':'åŠæœˆå‚¾æ–œï¼Œå¤œè‰²éœè¬',
  'æ®˜æœˆ':'æ·¡æœˆå¦‚é‰¤ï¼Œå¤©å…‰å°‡è‡³'
};

// åŒ—åŠçƒï¼ˆæ¨™æº–ï¼‰èˆ‡å—åŠçƒï¼ˆç¿»è½‰ï¼‰çš„ emoji å°æ‡‰
const emojiNorth = {
  'New Moon':'ğŸŒ‘','Waxing Crescent':'ğŸŒ’','First Quarter':'ğŸŒ“','Waxing Gibbous':'ğŸŒ”',
  'Full Moon':'ğŸŒ•','Waning Gibbous':'ğŸŒ–','Last Quarter':'ğŸŒ—','Waning Crescent':'ğŸŒ˜'
};
const emojiSouth = {
  'New Moon':'ğŸŒ‘','Waxing Crescent':'ğŸŒ˜','First Quarter':'ğŸŒ—','Waxing Gibbous':'ğŸŒ–',
  'Full Moon':'ğŸŒ•','Waning Gibbous':'ğŸŒ”','Last Quarter':'ğŸŒ“','Waning Crescent':'ğŸŒ’'
};
function pickMoonEmoji(phase, lat){
  const map = (lat>=0)?emojiNorth:emojiSouth;
  return map[phase] || 'ğŸŒ•';
}
function pad2(n){return String(n).padStart(2,'0');}
function localDateStr(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function getLocalTZHours(){ return -new Date().getTimezoneOffset()/60; }

// è§£æ USNO æ™‚é–“ï¼šæ”¯æ´ "07:06" æˆ– "7:06 am"/"pm"ï¼Œä»¥åŠ "on following day"
function parseUSNOTimeToDate(timestr, baseDate){
  if(!timestr) return null;
  const raw = String(timestr).trim().toLowerCase();
  const isNextDay = raw.includes('following day');
  const s = raw.replace('on following day','').replace(/\./g,'').trim();

  let hh=0, mm=0;
  const ampmMatch = s.match(/(\d{1,2}):(\d{2})\s*([ap]m)$/);
  const h24Match  = s.match(/^(\d{1,2}):(\d{2})$/);

  if(ampmMatch){
    hh = parseInt(ampmMatch[1],10); mm = parseInt(ampmMatch[2],10);
    const ap = ampmMatch[3];
    if(ap==='pm' && hh<12) hh+=12;
    if(ap==='am' && hh===12) hh=0;
  }else if(h24Match){
    hh = parseInt(h24Match[1],10); mm = parseInt(h24Match[2],10);
  }else{
    return null;
  }

  return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate() + (isNextDay?1:0), hh, mm, 0);
}

// AM/PM é¡¯ç¤º
function fmt12h(d){
  let h = d.getHours(), m = d.getMinutes();
  const ap = h>=12 ? 'PM' : 'AM';
  h = h%12; if(h===0) h=12;
  return `${h}:${pad2(m)}${ap}`;
}

async function loadMoonUSNO(lat, lon){
  const tz = getLocalTZHours(); // ç”¨ä½¿ç”¨è€…ç€è¦½å™¨æ‰€åœ¨æ™‚å€
  const today = new Date();
  const dateStr = localDateStr(today);
  const base = `https://aa.usno.navy.mil/api/rstt/oneday?date=${dateStr}&coords=${lat.toFixed(3)},${lon.toFixed(3)}&tz=${tz}`;

  try{
    const res = await fetch(base);
    const j = await res.json();
    const data = j?.properties?.data || {};

    // 1) ä»Šæ—¥æœˆç›¸ + emoji + æ¨™é¡Œ + æç¤ºèª
    const curphase = data.curphase || '';
    const fracillum = data.fracillum; // e.g. "4%"
    document.getElementById('moonEmoji').textContent = pickMoonEmoji(curphase, lat);
    const zh = zhPhase[curphase] || curphase || 'æœˆç›¸';
    document.getElementById('moon-title').textContent = zh || 'æœˆç›¸';
    document.getElementById('moon-hint').textContent = phaseHintZh[zh] || 'æœˆç›¸æ›´æ–°ä¸­';

    // 2) ç…§åº¦ï¼ˆç™¾åˆ†æ¯”å­—ä¸² â†’ ç›´æ¥é¡¯ç¤ºï¼‰
    if(typeof fracillum === 'string' && fracillum.trim()){
      const num = parseFloat(fracillum); // ä¾‹å¦‚ "4%" -> 4
      document.getElementById('moon-illum').textContent = Number.isFinite(num)? `${num}%` : 'â€”%';
    }else{
      document.getElementById('moon-illum').textContent = 'â€”%';
    }

    // 3) ä¸‹æ¬¡æœˆå‡ºï¼æœˆè½ï¼ˆå…ˆæŸ¥ä»Šå¤©ï¼Œå¿…è¦æ™‚æŸ¥æ˜å¤©ï¼‰
    const moondata = Array.isArray(data.moondata) ? data.moondata : [];
    const now = new Date();

    function pickNextRiseSet(list, baseDate){
      const rise = list.find(x=>/^rise$/i.test(x.phen));
      const setd = list.find(x=>/^set$/i.test(x.phen));
      const cand = [];
      if(rise){ const t=parseUSNOTimeToDate(rise.time, baseDate); if(t) cand.push({type:'æœˆå‡º', time:t}); }
      if(setd){ const t=parseUSNOTimeToDate(setd.time, baseDate); if(t) cand.push({type:'æœˆè½', time:t}); }
      const future = cand.filter(x=>x.time>now).sort((a,b)=>a.time-b.time);
      return future[0] || null;
    }

    let nextEvt = pickNextRiseSet(moondata, today);
    if(!nextEvt){
      // ä»Šå¤©éƒ½éäº† â†’ æŸ¥æ˜å¤©
      const tmr = new Date(today.getTime()+86400000);
      const url2=`https://aa.usno.navy.mil/api/rstt/oneday?date=${localDateStr(tmr)}&coords=${lat.toFixed(3)},${lon.toFixed(3)}&tz=${tz}`;
      try{
        const r2 = await fetch(url2).then(r=>r.json());
        const d2 = r2?.properties?.data || {};
        nextEvt = pickNextRiseSet(Array.isArray(d2.moondata)?d2.moondata:[], tmr);
      }catch{}
    }

    if(nextEvt){
      document.getElementById('moon-rise-type').textContent = `ä¸‹æ¬¡${nextEvt.type}`;
      document.getElementById('moon-rise-set').textContent  = fmt12h(nextEvt.time);
    }else{
      document.getElementById('moon-rise-type').textContent = 'æœˆå‡º/æœˆè½';
      document.getElementById('moon-rise-set').textContent  = 'â€”';
    }

    // 4) ä¸‹æ¬¡æ»¿æœˆå¤©æ•¸
    try{
      const purl = `https://aa.usno.navy.mil/api/moon/phases/date?date=${dateStr}&nump=8`;
      const pres = await fetch(purl).then(r=>r.json());
      const arr = pres?.phasedata || [];
      const nowUTCms = Date.now();
      const fm = arr.map(x=>{
        const [H='0',M='0']=String(x.time||'00:00').split(':');
        const utcMs = Date.UTC(x.year, (x.month||1)-1, x.day||1, parseInt(H,10)||0, parseInt(M,10)||0);
        return {phase:x.phase, utcMs};
      }).find(x=>/full moon/i.test(x.phase) && x.utcMs>=nowUTCms);

      if(fm){
        const diffDays = Math.ceil((fm.utcMs - nowUTCms)/86400000);
        document.getElementById('moon-next-full').textContent = `${diffDays} å¤©`;
      }else{
        document.getElementById('moon-next-full').textContent = 'â€” å¤©';
      }
    }catch{
      document.getElementById('moon-next-full').textContent = 'â€” å¤©';
    }

  }catch(e){
    console.error('USNO moon error', e);
    document.getElementById('moon-hint').textContent='æœˆç›¸è³‡æ–™å–å¾—å¤±æ•—';
    document.getElementById('moon-illum').textContent='â€”%';
    document.getElementById('moon-rise-set').textContent='â€”';
    document.getElementById('moon-next-full').textContent='â€” å¤©';
  }
}

/* ========= ä¸»è³‡æ–™è¼‰å…¥ï¼ˆçµ±ä¸€æ’ˆï¼‰ ========================================= */
async function loadAll(lat,lon,updateLocText=false){
  try{
    if(updateLocText){locText.textContent='å®šä½ä¸­â€¦';locText.textContent=await reverseGeocode(lat,lon);}

    /* ---- å¤©æ°£ï¼ˆé™¸åœ°ï¼‰ ---- */
    const urlForecast=new URL('https://api.open-meteo.com/v1/forecast');
    urlForecast.search=new URLSearchParams({
      latitude:lat, longitude:lon, timezone:'auto',
      current:['temperature_2m','apparent_temperature','relative_humidity_2m','uv_index','wind_speed_10m','wind_direction_10m','surface_pressure','weather_code'].join(','),
      hourly:['precipitation_probability'].join(','),
      daily:['temperature_2m_max','temperature_2m_min','sunrise','sunset','uv_index_max'].join(',')
    });
    const fRes=await fetch(urlForecast).then(r=>r.json());

    /* æº«åº¦/æ¿•åº¦ */
    document.getElementById('temp-now').textContent=Math.round(fRes.current.temperature_2m??0);
    document.getElementById('apparent').textContent=Math.round(fRes.current.apparent_temperature??0);
    document.getElementById('humidity').textContent=(fRes.current.relative_humidity_2m??0)+'%';

    /* å¤©æ°£åœ–ç¤ºèˆ‡æç¤º */
    const wmo=Number(fRes.current.weather_code??-1);
    setWeatherIconByWMO(document.getElementById('weatherIcon'), wmo);
    document.getElementById('weather-hint').textContent=WMO_HINT_ZH[wmo]||'å¤©æ°£æ›´æ–°ä¸­';

    /* UVï¼ˆæŒ‡æ•¸èˆ‡æç¤ºï¼‰ */
    const uv=Number(fRes.current.uv_index??0);
    document.getElementById('uv-index').textContent=uv.toFixed(0);
    document.getElementById('uv-hint').textContent=uvHintByIndex(uv);
    document.getElementById('uv-pin').style.left=Math.min(100,(uv/11)*100)+'%';

    /* hi/lo */
    const hi=fRes.daily?.temperature_2m_max?.[0], lo=fRes.daily?.temperature_2m_min?.[0];
    if(hi!=null)document.getElementById('temp-hi').textContent=Math.round(hi);
    if(lo!=null)document.getElementById('temp-lo').textContent=Math.round(lo);

    /* é™é›¨æ©Ÿç‡ï¼ˆæœ€è¿‘ä¸€ç­†ï¼‰ */
    const pp=fRes.hourly?.precipitation_probability?.[0];
    if(pp!=null)document.getElementById('precip-prob').textContent=pp+'%';

    /* é¢¨ï¼šBeaufort èˆ‡æç¤º */
    const ws=fRes.current.wind_speed_10m??0;  // km/h
    const wd=fRes.current.wind_direction_10m??0;
    const bft=kmhToBeaufort(ws);
    document.getElementById('wind-speed').textContent=Math.round(ws)+' å…¬é‡Œ/h';
    document.getElementById('wind-dir').textContent=degToCompass(wd)+' '+Math.round(wd)+'Â°';
    document.getElementById('wind-beaufort').textContent=bft+'ç´š';
    document.getElementById('wind-hint').textContent=windHintByBeaufort(bft);
    animateNeedle(wd);

    /* æ°£å£“ï¼šæ•¸å€¼èˆ‡æç¤º */
    const sp=fRes.current.surface_pressure;
    if(sp!=null)document.getElementById('pressure').textContent=Math.round(sp);
    document.getElementById('press-hint').textContent=pressureHintByHpa(sp??1013);

    /* ===== æ—¥å‡º/æ—¥è½å¡ç‰‡ï¼ˆä¾ç¾åœ¨ç‹€æ…‹åˆ‡æ›ï¼‰ ===== */
    const now=new Date();
    const srToday = fRes.daily?.sunrise?.[0] ? new Date(fRes.daily.sunrise[0]) : null;
    const ssToday = fRes.daily?.sunset?.[0]  ? new Date(fRes.daily.sunset[0])  : null;
    const srTomorrow = fRes.daily?.sunrise?.[1] ? new Date(fRes.daily.sunrise[1]) : null;

    if (srToday && ssToday){
      let headerText, nextLabel, nextTime;
      if (now >= srToday && now < ssToday){
        headerText='æ—¥è½'; nextLabel='ä¸‹æ¬¡æ—¥è½ï¼š'; nextTime=ssToday;
      }else{
        headerText='æ—¥å‡º'; nextLabel='ä¸‹æ¬¡æ—¥å‡ºï¼š';
        nextTime = (now < srToday ? srToday : (srTomorrow || srToday));
      }
      const hh=String(nextTime.getHours()).padStart(2,'0');
      const mm=String(nextTime.getMinutes()).padStart(2,'0');
      document.getElementById('sun-header-label').textContent = headerText;
      document.getElementById('sun-next-line').innerHTML = `${nextLabel}<span id="sun-next-time">${hh}:${mm}</span>`;
      document.getElementById('sun-hint').textContent = getPeriodHint(now);
    }else{
      const ns=fRes.daily?.sunrise?.[1]||fRes.daily?.sunrise?.[0];
      if(ns){
        const t=new Date(ns); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
        document.getElementById('sun-header-label').textContent='æ—¥å‡º';
        document.getElementById('sun-next-line').innerHTML=`ä¸‹æ¬¡æ—¥å‡ºï¼š<span id="sun-next-time">${hh}:${mm}</span>`;
        document.getElementById('sun-hint').textContent=getPeriodHint(new Date());
      }
    }
    /* ===== /æ—¥å‡ºæ—¥è½å¡ç‰‡ ===== */

  }catch(e){
    document.getElementById('weather-hint').textContent='å¤©æ°£è³‡æ–™å–å¾—å¤±æ•—';
    document.getElementById('wind-hint').textContent='è³‡æ–™è¼‰å…¥å¤±æ•—';
    document.getElementById('press-hint').textContent='è³‡æ–™è¼‰å…¥å¤±æ•—';
    document.getElementById('sun-hint').textContent='è³‡æ–™è¼‰å…¥å¤±æ•—';
    console.error('forecast error',e);
  }

  /* ---- æµ·æ³ + æ½®æ±ï¼ˆopen-meteo marineï¼‰ ---- */
  try{
    const urlMarine=new URL('https://marine-api.open-meteo.com/v1/marine');
    urlMarine.search=new URLSearchParams({
      latitude:lat, longitude:lon, timezone:'auto', cell_selection:'sea',
      current:[
        'ocean_current_velocity','ocean_current_direction',
        'sea_surface_temperature','wave_height','wave_direction',
        'sea_level_height_msl'
      ].join(','),
      hourly:['sea_level_height_msl'].join(',')
    });

    const mRes=await fetch(urlMarine).then(r=>r.json());

    /* ====== æµªæ³å¡ ====== */
    const cur=mRes.current||{};
    const curKmh=(cur.ocean_current_velocity??0);
    const curMsVal=curKmh*1000/3600;
    document.getElementById('wave-current').textContent=curMsVal.toFixed(1);

    const sst=cur.sea_surface_temperature;
    if(sst!=null)document.getElementById('sea-temp').textContent=Math.round(sst);
    document.getElementById('current-speed').textContent=curMsVal.toFixed(1);

    const wdir=cur.wave_direction??0;
    document.getElementById('wave-dir').textContent=`${Math.round(wdir)}Â° ${degToCompass(wdir)}`;

    const waveH = cur.wave_height;
    document.getElementById('wave-hint').textContent = waveHintByHeight(waveH);

    /* ====== æ½®æ±å¡ ====== */
    const tideNow = cur.sea_level_height_msl;
    if (tideNow != null){
      document.getElementById('tide-current').textContent = tideNow.toFixed(2);
    }

    const times = (mRes.hourly?.time||[]).map(t=>new Date(t));
    const heights = mRes.hourly?.sea_level_height_msl||[];

    const fmtHM = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    if (times.length > 2 && heights.length === times.length){
      const now = new Date();
      let idx = times.findIndex(t=>t > now);
      if (idx === -1) idx = times.length - 1;
      else if (idx > 0) idx -= 1;
      idx = Math.max(1, Math.min(idx, heights.length-2));

      const rising = heights[idx+1] > heights[idx] + 1e-6;
      const falling = heights[idx+1] < heights[idx] - 1e-6;
      const trend = rising ? 'ï¼ˆæ¼²æ½®ä¸­ï¼‰' : (falling ? 'ï¼ˆé€€æ½®ä¸­ï¼‰' : 'ï¼ˆå¹³æ½®ï¼‰');

      const nowH = (tideNow!=null) ? tideNow : heights[idx];
      document.getElementById('tide-hint').textContent = `${tideHintByHeight(nowH)}${trend}`;

      const findNextIdx = (start, cmp) => {
        for (let i=Math.max(1,start); i<heights.length-1; i++){
          if (cmp(heights[i-1], heights[i], heights[i+1])) return i;
        }
        return -1;
      };
      const isMin = (a,b,c)=> a>b && b<c;
      const isMax = (a,b,c)=> a<b && b>c;

      const lowIdx  = findNextIdx(idx, isMin);
      const highIdx = findNextIdx(idx, isMax);

      if (lowIdx !== -1){
        document.getElementById('tide-next-low-time').textContent = fmtHM(times[lowIdx]);
        document.getElementById('tide-next-low-height').textContent = `${heights[lowIdx].toFixed(2)} m`;
      }
      if (highIdx !== -1){
        document.getElementById('tide-next-high-time').textContent = fmtHM(times[highIdx]);
        document.getElementById('tide-next-high-height').textContent = `${heights[highIdx].toFixed(2)} m`;
      }
    }else{
      document.getElementById('tide-hint').textContent = 'æ½®æ±è³‡æ–™ä¸è¶³';
    }

    /* ====== è¨ˆç®—ä¸¦æ›´æ–° Fish Index ====== */
    const fishIdx=calcFishIndex({
      waveH,
      windKmh:window._weatherCache?.windKmh,
      uvIdx:window._weatherCache?.uv,
      tideH:tideNow
    });
    updateFishDial(86);
    document.getElementById('fish-hint').textContent=fishHintByIndex(86);

  }catch(e){
    document.getElementById('wave-hint').textContent='æµ·æ³è³‡æ–™å–å¾—å¤±æ•—';
    document.getElementById('tide-hint').textContent='æ½®æ±è³‡æ–™å–å¾—å¤±æ•—';
    console.error('marine error',e);
  }
}

/* ========= åˆå§‹åŒ– ========================================================= */
(async()=>{
  const {lat,lon}=await getCoords();
  locText.textContent=await reverseGeocode(lat,lon);
  await loadAll(lat,lon);
  await loadMoonUSNO(lat,lon);   // åˆå§‹åŒ–æœˆç›¸
})();
</script>
</body>
</html>
