<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>氣候資訊</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f0f0f; --text:#fff; --muted:rgba(255,255,255,.6);
  --accent:#ffcc9a; --cardTop:#2b2b2b; --cardBottom:#8a8a8a;
  --divider:rgba(255,255,255,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  display:flex;justify-content:center;align-items:flex-start;padding:16px;
}
/* 版心與網格 -----------------------------------------------------------------*/
.container{width:412px;padding-bottom:160px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
/* 卡片 -----------------------------------------------------------------------*/
.card{
  border-radius:20px;background:linear-gradient(180deg,var(--cardTop),var(--cardBottom));
  padding:14px 16px 16px;box-shadow:0 4px 10px rgba(0,0,0,.25);
  display:flex;flex-direction:column;min-height:170px;
}
.header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.header-left{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px;}
.header-left img{width:16px;height:16px;object-fit:contain;}
.chev{color:rgba(255,255,255,.55);font-size:18px;line-height:1;}
.hint{margin-top:6px;color:var(--accent);font-size:11px;}
.main{margin-top:6px;font-size:32px;line-height:1;letter-spacing:.2px;min-height:38px;}
.kvlist{margin-top:10px;border-top:1px solid var(--divider);padding-top:8px;}
.kv{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin:6px 0;}
.kv .left{display:flex;align-items:center;gap:8px;}
.kv .left img{width:14px;height:14px;object-fit:contain;opacity:.9;}
.kv .label{color:var(--muted);}
.kv .value{color:#fff;}
.value.neg{color:#7ec7ff;}.value.pos{color:#78e3cf;}

/* Fish card */
.card.fish{grid-column:1 / span 2;padding:16px 18px;min-height:auto;}
.fish .title{font-weight:600;letter-spacing:.3px;}
.fish .sub{margin-top:4px;color:var(--accent);font-size:11px;}
.fish .row{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  gap:12px;
}
.fish .period{text-align:center;line-height:1.35}
.fish .period .muted{color:rgba(255,255,255,.55);display:block;font-size:11px;margin-bottom:4px;}
.fish .period .time{font-size:12px;letter-spacing:.2px;}
.fish .dialwrap{position:relative;width:168px;height:168px;margin:0 auto;}
.fish object.dial{width:100%;height:100%;display:block;border:0;}

/* Weather card --------------------------------------------------------------*/
.weather .topline{display:flex;align-items:center;gap:10px;margin-top:6px;}
.weather .now{font-size:32px;}
.weather .icon{width:28px;height:28px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;}
.weather .icon img{width:100%;height:100%;object-fit:contain;display:block;}
.weather .hi-lo{font-size:11px;opacity:.85;line-height:1.15;}
/* Wave card -----------------------------------------------------------------*/
.wave .main{margin-bottom:2px;}
/* Wind card -----------------------------------------------------------------*/
.wind .dialwrap{margin-top:6px;position:relative;height:150px;}
.wind .rose{position:absolute;left:50%;top:0;transform:translateX(-50%);width:150px;height:150px;object-fit:contain;}
.wind .center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.35;}
.wind .center .lvl{font-size:16px;}
.wind .center .spd,.wind .center .dir{font-size:12px;}
/* UV ------------------------------------------------------------------------*/
.uv .uvbar{margin-top:8px;height:12px;border-radius:999px;background:linear-gradient(90deg,#fa6161,#d545fd);position:relative;overflow:hidden;}
.uv .uvbar .pin{position:absolute;left:6px;top:50%;transform:translateY(-50%);width:8px;height:8px;background:#fff;border-radius:50%;}
/* Pressure ------------------------------------------------------------------*/
.pressure .dialwrap{margin-top:6px;position:relative;height:120px;}
.pressure .gauge{position:absolute;left:50%;top:10px;transform:translateX(-50%);width:140px;height:96px;object-fit:contain;}
.pressure .read{position:absolute;left:0;right:0;top:40px;display:flex;flex-direction:column;align-items:center;gap:3px;}
.pressure .read .num{font-size:28px;}
.pressure .range{position:absolute;left:26px;right:26px;bottom:8px;display:flex;justify-content:space-between;font-size:11px;}
/* Moon ----------------------------------------------------------------------*/
.moon .moon-row{display:flex;align-items:center;gap:12px;margin-top:10px;}
.moon .moon-emoji{width:45px;height:45px;display:flex;align-items:center;justify-content:center;font-size:44px;line-height:1;}
.moon .stats{display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.35;}
.moon .stat-row{display:flex;align-items:center;gap:8px;}
.moon .stat-row img{width:14px;height:14px;object-fit:contain;opacity:.9;}
.moon .stat-row .label{color:var(--muted);}
/* Navbar --------------------------------------------------------------------*/
.navbar{
  position:fixed;left:50%;bottom:0;transform:translateX(-50%);
  width:412px;max-width:100vw;height:76px;z-index:50;
  background:#000;border-top:1px solid var(--divider);
  box-shadow:0 -6px 16px rgba(0,0,0,.35);padding-bottom:env(safe-area-inset-bottom);
}
.navbar .nav-inner{height:76px;display:flex;align-items:center;justify-content:space-between;padding:0 31px;}
.nav-item{width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;opacity:.6;background:none;border:0;padding:0;cursor:pointer;}
.nav-item img{width:30px;height:30px;object-fit:contain;display:block;}
.nav-item.active{opacity:1;filter:drop-shadow(0 2px 0 rgba(12,0,247,.15));}
/* Loc chip -----------------------------------------------------*/
.loc-chip{
  position:fixed;left:50%;bottom:96px;transform:translateX(-50%) translateY(20px);
  width:calc(100% - 48px);max-width:412px;z-index:60;
  display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
  background:rgba(0,0,0,.8);box-shadow:0 8px 24px rgba(0,0,0,.35);
  opacity:0;pointer-events:none;transition:.25s ease;
}
.loc-chip.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto;}
.loc-chip .left-ico{width:18px;height:18px;flex:0 0 auto;}
.loc-chip .right-btn{width:28px;height:28px;flex:0 0 auto;border-radius:999px;border:none;cursor:pointer;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;}
.loc-chip .right-btn img{width:18px;height:18px;}
.loc-chip .text{flex:1;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* Bottom sheet -------------------------------------------------*/
.sheet-mask{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:70;opacity:0;pointer-events:none;transition:.25s ease;}
.sheet-mask.show{opacity:1;pointer-events:auto;}
.sheet{
  position:fixed;left:50%;bottom:0;transform:translateX(-50%) translateY(100%);
  width:412px;max-width:100vw;z-index:75;background:linear-gradient(180deg,#2b2b2b,#8a8a8a);
  border-radius:20px 20px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.4);
  padding:14px 16px 24px;transition:.35s ease;
}
.sheet.show{transform:translateX(-50%) translateY(0);}
.sheet .sheet-header{display:flex;align-items:center;justify-content:space-between;}
.sheet .title{font-weight:600;}
.sheet .close{background:none;border:0;color:#fff;font-size:20px;cursor:pointer;opacity:.8;}
.sheet .search{margin:10px 0 12px;}
.sheet .search input{width:100%;height:36px;border-radius:10px;border:1px solid var(--divider);background:rgba(0,0,0,.25);color:#fff;padding:0 10px;outline:none;}
.sheet ul{list-style:none;padding:0;margin:0;max-height:40vh;overflow:auto;}
.sheet li{display:flex;align-items:center;gap:10px;padding:10px 6px;border-bottom:1px solid var(--divider);cursor:pointer;}
.sheet li:hover{background:rgba(0,0,0,.15);}
.sheet li img{width:16px;height:16px;}
@media(max-width:420px){
  .container{width:100%;max-width:412px;}
  .grid{grid-template-columns:1fr;}
  .card.fish{grid-column:auto;}
  .navbar{width:100%;max-width:412px;}
}
</style>
</head>
<body>
<div class="container">
  <div class="grid">

    <!-- 魚兒活躍指數 --------------------------------------------------------->
    <section class="card fish">
      <div class="header"><div class="title">魚兒活躍指數</div><div class="chev">›</div></div>
      <div class="sub" id="fish-hint">良好！魚群活躍</div>

      <div class="row">
        <!-- 左：主要活躍期 -->
        <div class="period">
          <span class="muted">主要活躍期</span>
          <div class="time">AM 7:31 — AM 10:01</div>
        </div>

        <!-- 中：圓形 SVG 錶盤 -->
        <div class="dialwrap" aria-label="魚兒活躍指數錶盤">
          <object id="fishDial" class="dial" data="assets/images/image_dashboard_fishinIndex.svg" type="image/svg+xml"></object>
        </div>

        <!-- 右：次級活躍期 -->
        <div class="period">
          <span class="muted">次級活躍期</span>
          <div class="time">AM 1:55 — AM 3:35</div>
        </div>
      </div>
    </section>

    <!-- 潮汐（open-meteo） --------------------------------------------------->
    <section class="card tide">
      <div class="header">
        <div class="header-left"><img src="assets/images/Icon_tide.png" alt=""><span>潮汐</span></div>
        <div class="chev">›</div>
      </div>
      <div class="hint" id="tide-hint">資料載入中…</div>
      <div class="main"><span id="tide-current">--</span> <span style="font-size:18px;">m</span></div>
      <div class="kvlist">
        <div class="kv"><div class="left"><span class="label">下次乾潮時間</span></div><span class="value" id="tide-next-low-time">—</span></div>
        <div class="kv"><div class="left"><span class="label">下次乾潮高度</span></div><span class="value neg" id="tide-next-low-height">—</span></div>
        <div class="kv"><div class="left"><span class="label">下次滿潮時間</span></div><span class="value" id="tide-next-high-time">—</span></div>
        <div class="kv"><div class="left"><span class="label">下次滿潮高度</span></div><span class="value pos" id="tide-next-high-height">—</span></div>
      </div>
    </section>

    <!-- 天氣 ----------------------------------------------------------------->
    <section class="card weather" id="card-weather">
      <div class="header"><div class="header-left"><span>天氣</span></div><div class="chev">›</div></div>
      <div class="hint" id="weather-hint">資料載入中…</div>
      <div class="topline">
        <div class="now"><span id="temp-now">--</span>°</div>
        <div class="icon" id="weatherIcon" role="img" aria-label="天氣圖示"></div>
        <div class="hi-lo">↑ <span id="temp-hi">--</span>°C<br>↓ <span id="temp-lo">--</span>°C</div>
      </div>
      <div class="kvlist">
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_precipitation_probability.png" alt=""><span class="label">降雨機率</span></div>
          <span class="value" id="precip-prob">--%</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_apparent_temperature.png" alt=""><span class="label">體感溫度</span></div>
          <span class="value"><span id="apparent">--</span>°</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_relative_humidity_2m.png" alt=""><span class="label">濕度</span></div>
          <span class="value" id="humidity">--%</span>
        </div>
      </div>
    </section>

    <!-- 浪況 ----------------------------------------------------------------->
    <section class="card wave" id="card-wave">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_wave.png" alt=""><span>浪況</span></div><div class="chev">›</div></div>
      <div class="hint" id="wave-hint">資料載入中…</div>
      <div class="main"><span id="wave-current">--</span> <span style="font-size:18px;">m/s</span></div>
      <div class="kvlist">
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wavetemperture.png" alt=""><span class="label">海洋溫度</span></div>
          <span class="value"><span id="sea-temp">--</span>°</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wavespeed.png" alt=""><span class="label">海流速度</span></div>
          <span class="value"><span id="current-speed">--</span> m/s</span>
        </div>
        <div class="kv">
          <div class="left"><img src="assets/images/Icon_wave_direction.png" alt=""><span class="label">浪的方向</span></div>
          <span class="value" id="wave-dir">--</span>
        </div>
      </div>
    </section>

    <!-- 風 ------------------------------------------------------------------->
    <section class="card wind" id="card-wind">
      <div class="header"><div class="header-left"><img src="assets/images/icon_wind.png" alt=""><span>風</span></div><div class="chev">›</div></div>
      <div class="hint" id="wind-hint">資料載入中…</div>
      <div class="dialwrap">
        <object id="windRose" class="rose" data="assets/images/dashboardMockup_wind.svg" type="image/svg+xml"></object>
        <div class="center">
          <div class="lvl" id="wind-beaufort">—級</div>
          <div class="spd" id="wind-speed">— 公里/h</div>
          <div class="dir" id="wind-dir">—°</div>
        </div>
      </div>
    </section>

    <!-- 紫外線 --------------------------------------------------------------->
    <section class="card uv" id="card-uv">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_uv.png" alt=""><span>紫外線</span></div><div class="chev">›</div></div>
      <div class="hint" id="uv-hint">資料載入中…</div>
      <div class="main" id="uv-index">0</div>
      <div class="uvbar"><span class="pin" id="uv-pin" aria-hidden="true"></span></div>
    </section>

    <!-- 氣壓 ----------------------------------------------------------------->
    <section class="card pressure" id="card-pressure">
      <div class="header"><div class="header-left"><img src="assets/images/Icon_surface_pressure.png" alt="" style="width:14px;height:14px;"><span>氣壓</span></div><div class="chev">›</div></div>
      <div class="hint" id="press-hint">資料載入中…</div>
      <div class="dialwrap">
        <img class="gauge" src="assets/images/Dashboardmockup_surface_pressure.png" alt="">
        <div class="read">
          <div>↓</div>
          <div class="num" id="pressure">—</div>
          <div style="font-size:12px;">百帕</div>
        </div>
        <div class="range"><span>低</span><span>高</span></div>
      </div>
    </section>

    <!-- 月相 --------------------------------------------------------------->
    <section class="card moon">
      <div class="header"><div class="header-left"><span id="moon-title">月相</span></div><div class="chev">›</div></div>
      <div class="hint" id="moon-hint">資料載入中…</div>
      <div class="moon-row">
        <div id="moonEmoji" class="moon-emoji" role="img" aria-label="月相">🌘</div>
        <div class="stats">
          <div class="stat-row">
            <img src="assets/images/Icon_birghtness.png" alt="">
            <span class="label">照度</span><span class="value" id="moon-illum">—%</span>
          </div>
          <div class="stat-row">
            <img src="assets/images/Icon_moonset.png" alt="">
            <span class="label" id="moon-rise-type">月出/月落</span><span class="value" id="moon-rise-set">—</span>
          </div>
          <div class="stat-row">
            <img src="assets/images/icon_fullMoon.png" alt="">
            <span class="label">下次滿月</span><span class="value" id="moon-next-full">— 天</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 日落 / 日出 ----------------------------------------------------------->
    <section class="card" id="card-sun">
      <div class="header">
        <div class="header-left">
          <img src="assets/images/Icon_sun.png" alt="" style="width:16px;height:10px;">
          <span id="sun-header-label">日落</span>
        </div>
        <div class="chev">›</div>
      </div>
      <div class="hint" id="sun-hint">資料載入中…</div>
      <div style="margin-top:10px;display:flex;justify-content:center;">
        <img class="dial" src="assets/images/Dashboardmockup_sun.png" width="120" alt="">
      </div>
      <div id="sun-next-line" style="margin-top:8px;font-size:12px;">下次日出：<span id="sun-next-time">—</span></div>
    </section>

  </div>
</div>

<!-- 漂浮地區選擇器 ----------------------------------------------------------->
<div class="loc-chip" id="locChip" role="button" aria-label="選擇地區">
  <img class="left-ico" src="assets/images/icon_selectable.png" alt="">
  <div class="text" id="locText">定位中…</div>
  <button class="right-btn" id="openSheetBtn" aria-label="開啟地區選單">
    <img src="assets/images/icon_locationmain.png" alt="">
  </button>
</div>

<!-- 地點 Bottom Sheet --------------------------------------------------------->
<div class="sheet-mask" id="sheetMask"></div>
<section class="sheet" id="sheet">
  <div class="sheet-header">
    <div class="title">選擇地區</div>
    <button class="close" id="sheetClose" aria-label="關閉">✕</button>
  </div>
  <div class="search"><input type="search" id="placeSearch" placeholder="搜尋地點或關鍵字"></div>
  <ul id="placeList"></ul>
</section>

<!-- Navbar ------------------------------------------------------------------->
<nav class="navbar" role="navigation" aria-label="底部導覽">
  <div class="nav-inner">
    <button class="nav-item active" aria-label="今天" data-nav="today"><img src="assets/images/Icon_nav_today.png" alt=""></button>
    <button class="nav-item" aria-label="週預報" data-nav="weekly"><img src="assets/images/Icon_nav_weeklypredict.png" alt=""></button>
    <button class="nav-item" aria-label="相機" data-nav="camera"><img src="assets/images/Icon_nav_camera.png" alt=""></button>
    <button class="nav-item" aria-label="我的位置" data-nav="location" id="navLocation"><img src="assets/images/Icon_nav_mylocation.png" alt=""></button>
    <button class="nav-item" aria-label="設定" data-nav="settings"><img src="assets/images/Icon_nav_setting.png" alt=""></button>
  </div>
</nav>

<script>
/* ========= 風向儀動畫 ===================================================== */
let currentNeedleAngle = 0;
function updateNeedle(angle){
  const svg = document.getElementById('windRose').contentDocument;
  if(!svg) return;
  svg.querySelectorAll('.st0').forEach(el=>{
    el.setAttribute('transform',`rotate(${(angle)%360} 100 100)`);
  });
}
function animateNeedle(target){
  const shortest=((target-currentNeedleAngle+540)%360)-180;
  const start=performance.now(),dur=800;
  const ease=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
  function step(now){
    const p=Math.min(1,(now-start)/dur);
    updateNeedle(currentNeedleAngle+shortest*ease(p));
    if(p<1)requestAnimationFrame(step);else currentNeedleAngle=target;
  }
  requestAnimationFrame(step);
}

/* ========= 魚兒活躍指數 =================================================== */
/* 簡易計算：0–100；高→活躍 */
function calcFishIndex({waveH, windKmh, uvIdx, tideH}){
  let score = 100;
  if(waveH!=null) score -= Math.max(0,(waveH-0.5))*15;     // 浪高影響
  if(windKmh!=null) score -= Math.max(0,(windKmh-15))*1.2;  // 強風影響
  if(uvIdx!=null) score -= Math.max(0,(uvIdx-5))*4;         // 高紫外線
  if(tideH!=null && tideH<0) score -= Math.abs(tideH)*8;    // 乾潮
  return Math.round(Math.max(0,Math.min(100,score)));
}
function fishHintByIndex(i){
  if(i>=80) return '極佳！大量咬餌';
  if(i>=60) return '良好！魚群活躍';
  if(i>=40) return '普通，需要耐心';
  return '較差，咬餌稀少';
}
function updateFishDial(val){
  const obj=document.getElementById('fishDial');
  const svg=obj?.contentDocument;
  if(!svg) return;
  const label=svg.getElementById('fish-index-label');
  if(label) label.textContent=val;
  /* 若要做環形進度條，可在此調整 progress-ring 的 stroke-dasharray */
}

/* ========= Navbar Active 標示 ============================================= */
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* ========= LocChip 滾動影藏 ============================================== */
const locChip=document.getElementById('locChip');
let sheetOpen=false,lastY=window.scrollY;
locChip.classList.add('show');
window.addEventListener('scroll',()=>{
  if(sheetOpen)return;
  const y=window.scrollY;
  if(y>lastY)locChip.classList.remove('show');else if(y<lastY)locChip.classList.add('show');
  lastY=y;
},{passive:true});

/* ========= Bottom Sheet 控制 ============================================= */
const sheetMask=document.getElementById('sheetMask'),sheet=document.getElementById('sheet'),openSheetBtn=document.getElementById('openSheetBtn'),sheetClose=document.getElementById('sheetClose');
function openSheet(){sheetOpen=true;locChip.classList.add('show');sheet.classList.add('show');sheetMask.classList.add('show');}
function closeSheet(){sheetOpen=false;sheet.classList.remove('show');sheetMask.classList.remove('show');}
openSheetBtn.addEventListener('click',openSheet);
locChip.addEventListener('click',openSheet);
sheetMask.addEventListener('click',closeSheet);
sheetClose.addEventListener('click',closeSheet);

/* ========= 地點清單 ======================================================= */
const FAVORITES=[
  {name:'使用目前位置',useCurrent:true},
  {name:'梧棲漁港（台中）',lat:24.256,lon:120.508},
  {name:'基隆港',lat:25.15,lon:121.75},
  {name:'淡水河出海口',lat:25.17,lon:121.40},
  {name:'馬公港（澎湖）',lat:23.566,lon:119.566}
];
const placeList=document.getElementById('placeList'),placeSearch=document.getElementById('placeSearch');
function renderList(kw=''){
  placeList.innerHTML='';
  FAVORITES.filter(p=>p.useCurrent||p.name.toLowerCase().includes(kw.toLowerCase())).forEach(p=>{
    const li=document.createElement('li');
    li.innerHTML=`<img src="assets/images/icon_selectable.png" alt=""><span>${p.name}</span>`;
    li.addEventListener('click',async()=>{
      closeSheet();
      const {lat,lon}=p.useCurrent?await getCoords():{lat:p.lat,lon:p.lon};
      await loadAll(lat,lon,true);
      await loadMoonUSNO(lat,lon);   // 更新月相
      window.scrollTo({top:0,behavior:'smooth'});
    });
    placeList.appendChild(li);
  });
}
placeSearch.addEventListener('input',e=>renderList(e.target.value));
renderList();

/* ========= 工具函式（提示詞對應） ======================================= */
const kmhToBeaufort=kmh=>[1,5,11,19,28,38,49,61,74,88,102,117,9999].findIndex(x=>kmh<=x);
const degToCompass=deg=>["北","北北東","東北","東北東","東","東南東","東南","南南東","南","南南西","西南","西南西","西","西北西","西北","北北西"][Math.round(deg/22.5)%16];

const tideHintByHeight=h=>{
  const x=Math.max(0, h);
  if(x<=0.5) return '海灘範圍寬，適合沿岸走走';
  if(x<=1.5) return '岸邊活動舒適，留意浪花';
  if(x<=2.5) return '岸邊注意腳下安全';
  if(x<=3.5) return '建議保持與水邊適當距離';
  return '請避免站在浪拍打的區域';
};

const waveHintByHeight=h=>{
  if(h==null) return '海況更新中';
  if(h<=0.5) return '海面平靜，適合岸邊散步。';
  if(h<=1.0) return '海面微有波動，岸邊活動舒適。';
  if(h<=1.5) return '浪高增加，留意安全。';
  if(h<=2.5) return '浪高偏高，岸邊活動保持距離。';
  return '浪勢明顯，避免靠近海浪拍打區。';
};

const windHintByBeaufort=b=>{
  return [
    '幾乎無風，空氣靜止',
    '微風輕拂，幾乎感受不到',
    '微風輕柔，葉子輕輕擺動',
    '小風擾動，樹梢微微擺動',
    '微強的風，小心帽子飛走',
    '中等強風，注意保暖防護',
    '強風來襲，戶外活動小心',
    '烈風明顯，可能行走困難',
    '烈風增強，戶外活動不建議',
    '請待在室內確保安全'
  ][Math.min(b,9)];
};

const uvHintByIndex=u=>{
  if(u<=2) return '幾乎不用擔心曬傷';
  if(u<=5) return '記得戴帽防曬';
  if(u<=7) return '應多補擦防曬';
  if(u<=10) return '防曬衣物不可少';
  return '建議縮短戶外時間';
};

const pressureHintByHpa=p=>{
  if(p>1015) return '天氣穩定，適合戶外走走';
  if(p>=1005) return '氣壓平衡，空氣清爽';
  return '天氣微陰，留意身體狀況';
};

const locText=document.getElementById('locText');
async function reverseGeocode(lat,lon){
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const j=await res.json();
    return j.display_name||`${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  }catch{return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;}
}
const getCoords=()=>new Promise(resolve=>{
  if(location.protocol==='https:'||location.hostname==='localhost'){
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat:pos.coords.latitude,lon:pos.coords.longitude}),
      async()=>{
        try{
          const ip=await fetch('https://ipapi.co/json/').then(r=>r.json());
          resolve({lat:ip.latitude,lon:ip.longitude});
        }catch{resolve({lat:24.256,lon:120.508});}
      },
      {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
    );
  }else{
    fetch('https://ipapi.co/json/').then(r=>r.json()).then(ip=>resolve({lat:ip.latitude,lon:ip.longitude})).catch(()=>resolve({lat:24.256,lon:120.508}));
  }
});

/* ========= 時段提示（依附圖，不重疊分段） ================================ */
function getPeriodHint(date){
  const m = date.getHours()*60 + date.getMinutes();
  if (m < 240)   return '深夜寧靜，適合思考或入眠。';
  if (m < 360)   return '晨曦初現，萬物甦醒。';
  if (m < 480)   return '天光乍現，新的一天開始。';
  if (m < 660)   return '朝氣蓬勃，是活動的時段。';
  if (m < 780)   return '日正當中，溫度逐漸升高。';
  if (m < 960)   return '午後時段，適合輕活動。';
  if (m < 1140)  return '夕陽西下，光影溫柔。';
  return '燈火初上，靜享夜色。';
}

/* ========= WMO 對應（圖示/提示） ========================================= */
const WMO_ICON_MAP={0:{label:'Clear',slug:'clear'},1:{label:'Mostly Clear',slug:'mostly-clear'},2:{label:'Partly Cloudy',slug:'partly-cloudy'},3:{label:'Overcast',slug:'overcast'},45:{label:'Fog',slug:'fog'},48:{label:'Icy Fog',slug:'rime-fog'},51:{label:'Light Drizzle',slug:'light-drizzle'},53:{label:'Drizzle',slug:'moderate-drizzle'},55:{label:'Heavy Drizzle',slug:'dense-drizzle'},80:{label:'Light Showers',slug:'light-rain'},81:{label:'Showers',slug:'moderate-rain'},82:{label:'Heavy Showers',slug:'heavy-rain'},61:{label:'Light Rain',slug:'light-rain'},63:{label:'Rain',slug:'moderate-rain'},65:{label:'Heavy Rain',slug:'heavy-rain'},56:{label:'Light Freezing Drizzle',slug:'light-freezing-drizzle'},57:{label:'Freezing Drizzle',slug:'dense-freezing-drizzle'},66:{label:'Light Freezing Rain',slug:'light-freezing-rain'},67:{label:'Freezing Rain',slug:'heavy-freezing-rain'},71:{label:'Light Snow',slug:'slight-snowfall'},73:{label:'Snow',slug:'moderate-snowfall'},75:{label:'Heavy Snow',slug:'heavy-snowfall'},77:{label:'Snow Grains',slug:'snowflake'},85:{label:'Light Snow Showers',slug:'slight-snowfall'},86:{label:'Snow Showers',slug:'heavy-snowfall'},95:{label:'Thunderstorm',slug:'thunderstorm'},96:{label:'Light T-storm w/ Hail',slug:'thunderstorm-with-hail'},99:{label:'T-storm w/ Hail',slug:'thunderstorm-with-hail'}};
const AIRY_BASE='https://raw.githubusercontent.com/Leftium/weather-sense/refs/heads/main/static/icons/airy';
const EMOJI_FALLBACK={'clear':'☀️','mostly-clear':'🌤️','partly-cloudy':'⛅️','overcast':'☁️','fog':'🌫️','rime-fog':'🌫️','light-drizzle':'🌦️','moderate-drizzle':'🌦️','dense-drizzle':'🌧️','light-rain':'🌧️','moderate-rain':'🌧️','heavy-rain':'🌧️','light-freezing-drizzle':'🌨️','dense-freezing-drizzle':'🌨️','light-freezing-rain':'🌨️','heavy-freezing-rain':'🌨️','slight-snowfall':'❄️','moderate-snowfall':'❄️','heavy-snowfall':'❄️','snowflake':'❄️','thunderstorm':'⛈️','thunderstorm-with-hail':'⛈️'};
function setWeatherIconByWMO(container,wmo){
  const rec=WMO_ICON_MAP[wmo]||{label:'Unknown',slug:'overcast'};
  const url=`${AIRY_BASE}/${rec.slug}@4x.png`;
  container.innerHTML='';
  const img=document.createElement('img');
  img.src=url; img.alt=rec.label; img.referrerPolicy='no-referrer';
  img.onerror=()=>{container.innerHTML=`<span style="font-size:18px;line-height:1">${EMOJI_FALLBACK[rec.slug]||'❓'}</span>`;};
  container.appendChild(img);
}
const WMO_HINT_ZH={0:'今天天氣晴朗心情好',1:'天空多雲但仍舒適',2:'陽光與雲朵交錯',3:'陰天出門記得帶外套',45:'霧氣較重，行車請小心',48:'霜霧低能見度，注意安全',51:'毛毛雨，出門帶把傘',53:'細雨綿綿，記得防水',55:'小雨偏強，外出要備雨具',80:'短暫陣雨，別忘了雨傘',81:'陣雨明顯，路面濕滑小心',82:'強陣雨，外出請小心',61:'小雨滴答，帶件薄外套',63:'中雨來訪，行車放慢速度',65:'大雨滂沱，留意積水',56:'小冰霰／凍毛雨，路面易滑',57:'凍毛雨偏強，注意結冰',66:'小凍雨，請小心路滑',67:'凍雨較強，當心結冰',71:'小雪紛飛，注意保暖',73:'中雪飄落，外出請注意',75:'大雪／暴雪，交通恐受影響',77:'雪粒飄落，能見度略降',85:'小雪陣雪，風大時更冷',86:'強陣雪，視線不佳',95:'雷雨發展，遠離空曠與樹下',96:'雷雨夾雹，待在室內較安全',99:'強雷雨夾雹，務必注意安全'};

/* ========= 月相（USNO） =================================================== */
// 月相中文字
const zhPhase = {
  'New Moon':'新月','Full Moon':'滿月',
  'First Quarter':'上弦月','Last Quarter':'下弦月',
  'Waxing Crescent':'峨眉月','Waning Crescent':'殘月',
  'Waxing Gibbous':'盈凸月','Waning Gibbous':'虧凸月'
};
// 你的提示語（依月相顯示）
const phaseHintZh = {
  '新月':'黑夜無光，夜空顯得格外寧靜',
  '峨眉月':'月光初現，天空透出溫柔光暈',
  '上弦月':'半輪明月，如切如磋',
  '盈凸月':'月輪漸圓，光彩漸明',
  '滿月':'月色皎潔，萬物染上銀輝',
  '虧凸月':'光影退隱，夜晚漸深',
  '下弦月':'半月傾斜，夜色靜謐',
  '殘月':'淡月如鉤，天光將至'
};

// 北半球（標準）與南半球（翻轉）的 emoji 對應
const emojiNorth = {
  'New Moon':'🌑','Waxing Crescent':'🌒','First Quarter':'🌓','Waxing Gibbous':'🌔',
  'Full Moon':'🌕','Waning Gibbous':'🌖','Last Quarter':'🌗','Waning Crescent':'🌘'
};
const emojiSouth = {
  'New Moon':'🌑','Waxing Crescent':'🌘','First Quarter':'🌗','Waxing Gibbous':'🌖',
  'Full Moon':'🌕','Waning Gibbous':'🌔','Last Quarter':'🌓','Waning Crescent':'🌒'
};
function pickMoonEmoji(phase, lat){
  const map = (lat>=0)?emojiNorth:emojiSouth;
  return map[phase] || '🌕';
}
function pad2(n){return String(n).padStart(2,'0');}
function localDateStr(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function getLocalTZHours(){ return -new Date().getTimezoneOffset()/60; }

// 解析 USNO 時間：支援 "07:06" 或 "7:06 am"/"pm"，以及 "on following day"
function parseUSNOTimeToDate(timestr, baseDate){
  if(!timestr) return null;
  const raw = String(timestr).trim().toLowerCase();
  const isNextDay = raw.includes('following day');
  const s = raw.replace('on following day','').replace(/\./g,'').trim();

  let hh=0, mm=0;
  const ampmMatch = s.match(/(\d{1,2}):(\d{2})\s*([ap]m)$/);
  const h24Match  = s.match(/^(\d{1,2}):(\d{2})$/);

  if(ampmMatch){
    hh = parseInt(ampmMatch[1],10); mm = parseInt(ampmMatch[2],10);
    const ap = ampmMatch[3];
    if(ap==='pm' && hh<12) hh+=12;
    if(ap==='am' && hh===12) hh=0;
  }else if(h24Match){
    hh = parseInt(h24Match[1],10); mm = parseInt(h24Match[2],10);
  }else{
    return null;
  }

  return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate() + (isNextDay?1:0), hh, mm, 0);
}

// AM/PM 顯示
function fmt12h(d){
  let h = d.getHours(), m = d.getMinutes();
  const ap = h>=12 ? 'PM' : 'AM';
  h = h%12; if(h===0) h=12;
  return `${h}:${pad2(m)}${ap}`;
}

async function loadMoonUSNO(lat, lon){
  const tz = getLocalTZHours(); // 用使用者瀏覽器所在時區
  const today = new Date();
  const dateStr = localDateStr(today);
  const base = `https://aa.usno.navy.mil/api/rstt/oneday?date=${dateStr}&coords=${lat.toFixed(3)},${lon.toFixed(3)}&tz=${tz}`;

  try{
    const res = await fetch(base);
    const j = await res.json();
    const data = j?.properties?.data || {};

    // 1) 今日月相 + emoji + 標題 + 提示語
    const curphase = data.curphase || '';
    const fracillum = data.fracillum; // e.g. "4%"
    document.getElementById('moonEmoji').textContent = pickMoonEmoji(curphase, lat);
    const zh = zhPhase[curphase] || curphase || '月相';
    document.getElementById('moon-title').textContent = zh || '月相';
    document.getElementById('moon-hint').textContent = phaseHintZh[zh] || '月相更新中';

    // 2) 照度（百分比字串 → 直接顯示）
    if(typeof fracillum === 'string' && fracillum.trim()){
      const num = parseFloat(fracillum); // 例如 "4%" -> 4
      document.getElementById('moon-illum').textContent = Number.isFinite(num)? `${num}%` : '—%';
    }else{
      document.getElementById('moon-illum').textContent = '—%';
    }

    // 3) 下次月出／月落（先查今天，必要時查明天）
    const moondata = Array.isArray(data.moondata) ? data.moondata : [];
    const now = new Date();

    function pickNextRiseSet(list, baseDate){
      const rise = list.find(x=>/^rise$/i.test(x.phen));
      const setd = list.find(x=>/^set$/i.test(x.phen));
      const cand = [];
      if(rise){ const t=parseUSNOTimeToDate(rise.time, baseDate); if(t) cand.push({type:'月出', time:t}); }
      if(setd){ const t=parseUSNOTimeToDate(setd.time, baseDate); if(t) cand.push({type:'月落', time:t}); }
      const future = cand.filter(x=>x.time>now).sort((a,b)=>a.time-b.time);
      return future[0] || null;
    }

    let nextEvt = pickNextRiseSet(moondata, today);
    if(!nextEvt){
      // 今天都過了 → 查明天
      const tmr = new Date(today.getTime()+86400000);
      const url2=`https://aa.usno.navy.mil/api/rstt/oneday?date=${localDateStr(tmr)}&coords=${lat.toFixed(3)},${lon.toFixed(3)}&tz=${tz}`;
      try{
        const r2 = await fetch(url2).then(r=>r.json());
        const d2 = r2?.properties?.data || {};
        nextEvt = pickNextRiseSet(Array.isArray(d2.moondata)?d2.moondata:[], tmr);
      }catch{}
    }

    if(nextEvt){
      document.getElementById('moon-rise-type').textContent = `下次${nextEvt.type}`;
      document.getElementById('moon-rise-set').textContent  = fmt12h(nextEvt.time);
    }else{
      document.getElementById('moon-rise-type').textContent = '月出/月落';
      document.getElementById('moon-rise-set').textContent  = '—';
    }

    // 4) 下次滿月天數
    try{
      const purl = `https://aa.usno.navy.mil/api/moon/phases/date?date=${dateStr}&nump=8`;
      const pres = await fetch(purl).then(r=>r.json());
      const arr = pres?.phasedata || [];
      const nowUTCms = Date.now();
      const fm = arr.map(x=>{
        const [H='0',M='0']=String(x.time||'00:00').split(':');
        const utcMs = Date.UTC(x.year, (x.month||1)-1, x.day||1, parseInt(H,10)||0, parseInt(M,10)||0);
        return {phase:x.phase, utcMs};
      }).find(x=>/full moon/i.test(x.phase) && x.utcMs>=nowUTCms);

      if(fm){
        const diffDays = Math.ceil((fm.utcMs - nowUTCms)/86400000);
        document.getElementById('moon-next-full').textContent = `${diffDays} 天`;
      }else{
        document.getElementById('moon-next-full').textContent = '— 天';
      }
    }catch{
      document.getElementById('moon-next-full').textContent = '— 天';
    }

  }catch(e){
    console.error('USNO moon error', e);
    document.getElementById('moon-hint').textContent='月相資料取得失敗';
    document.getElementById('moon-illum').textContent='—%';
    document.getElementById('moon-rise-set').textContent='—';
    document.getElementById('moon-next-full').textContent='— 天';
  }
}

/* ========= 主資料載入（統一撈） ========================================= */
async function loadAll(lat,lon,updateLocText=false){
  try{
    if(updateLocText){locText.textContent='定位中…';locText.textContent=await reverseGeocode(lat,lon);}

    /* ---- 天氣（陸地） ---- */
    const urlForecast=new URL('https://api.open-meteo.com/v1/forecast');
    urlForecast.search=new URLSearchParams({
      latitude:lat, longitude:lon, timezone:'auto',
      current:['temperature_2m','apparent_temperature','relative_humidity_2m','uv_index','wind_speed_10m','wind_direction_10m','surface_pressure','weather_code'].join(','),
      hourly:['precipitation_probability'].join(','),
      daily:['temperature_2m_max','temperature_2m_min','sunrise','sunset','uv_index_max'].join(',')
    });
    const fRes=await fetch(urlForecast).then(r=>r.json());

    /* 溫度/濕度 */
    document.getElementById('temp-now').textContent=Math.round(fRes.current.temperature_2m??0);
    document.getElementById('apparent').textContent=Math.round(fRes.current.apparent_temperature??0);
    document.getElementById('humidity').textContent=(fRes.current.relative_humidity_2m??0)+'%';

    /* 天氣圖示與提示 */
    const wmo=Number(fRes.current.weather_code??-1);
    setWeatherIconByWMO(document.getElementById('weatherIcon'), wmo);
    document.getElementById('weather-hint').textContent=WMO_HINT_ZH[wmo]||'天氣更新中';

    /* UV（指數與提示） */
    const uv=Number(fRes.current.uv_index??0);
    document.getElementById('uv-index').textContent=uv.toFixed(0);
    document.getElementById('uv-hint').textContent=uvHintByIndex(uv);
    document.getElementById('uv-pin').style.left=Math.min(100,(uv/11)*100)+'%';

    /* hi/lo */
    const hi=fRes.daily?.temperature_2m_max?.[0], lo=fRes.daily?.temperature_2m_min?.[0];
    if(hi!=null)document.getElementById('temp-hi').textContent=Math.round(hi);
    if(lo!=null)document.getElementById('temp-lo').textContent=Math.round(lo);

    /* 降雨機率（最近一筆） */
    const pp=fRes.hourly?.precipitation_probability?.[0];
    if(pp!=null)document.getElementById('precip-prob').textContent=pp+'%';

    /* 風：Beaufort 與提示 */
    const ws=fRes.current.wind_speed_10m??0;  // km/h
    const wd=fRes.current.wind_direction_10m??0;
    const bft=kmhToBeaufort(ws);
    document.getElementById('wind-speed').textContent=Math.round(ws)+' 公里/h';
    document.getElementById('wind-dir').textContent=degToCompass(wd)+' '+Math.round(wd)+'°';
    document.getElementById('wind-beaufort').textContent=bft+'級';
    document.getElementById('wind-hint').textContent=windHintByBeaufort(bft);
    animateNeedle(wd);

    /* 氣壓：數值與提示 */
    const sp=fRes.current.surface_pressure;
    if(sp!=null)document.getElementById('pressure').textContent=Math.round(sp);
    document.getElementById('press-hint').textContent=pressureHintByHpa(sp??1013);

    /* ===== 日出/日落卡片（依現在狀態切換） ===== */
    const now=new Date();
    const srToday = fRes.daily?.sunrise?.[0] ? new Date(fRes.daily.sunrise[0]) : null;
    const ssToday = fRes.daily?.sunset?.[0]  ? new Date(fRes.daily.sunset[0])  : null;
    const srTomorrow = fRes.daily?.sunrise?.[1] ? new Date(fRes.daily.sunrise[1]) : null;

    if (srToday && ssToday){
      let headerText, nextLabel, nextTime;
      if (now >= srToday && now < ssToday){
        headerText='日落'; nextLabel='下次日落：'; nextTime=ssToday;
      }else{
        headerText='日出'; nextLabel='下次日出：';
        nextTime = (now < srToday ? srToday : (srTomorrow || srToday));
      }
      const hh=String(nextTime.getHours()).padStart(2,'0');
      const mm=String(nextTime.getMinutes()).padStart(2,'0');
      document.getElementById('sun-header-label').textContent = headerText;
      document.getElementById('sun-next-line').innerHTML = `${nextLabel}<span id="sun-next-time">${hh}:${mm}</span>`;
      document.getElementById('sun-hint').textContent = getPeriodHint(now);
    }else{
      const ns=fRes.daily?.sunrise?.[1]||fRes.daily?.sunrise?.[0];
      if(ns){
        const t=new Date(ns); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
        document.getElementById('sun-header-label').textContent='日出';
        document.getElementById('sun-next-line').innerHTML=`下次日出：<span id="sun-next-time">${hh}:${mm}</span>`;
        document.getElementById('sun-hint').textContent=getPeriodHint(new Date());
      }
    }
    /* ===== /日出日落卡片 ===== */

  }catch(e){
    document.getElementById('weather-hint').textContent='天氣資料取得失敗';
    document.getElementById('wind-hint').textContent='資料載入失敗';
    document.getElementById('press-hint').textContent='資料載入失敗';
    document.getElementById('sun-hint').textContent='資料載入失敗';
    console.error('forecast error',e);
  }

  /* ---- 海況 + 潮汐（open-meteo marine） ---- */
  try{
    const urlMarine=new URL('https://marine-api.open-meteo.com/v1/marine');
    urlMarine.search=new URLSearchParams({
      latitude:lat, longitude:lon, timezone:'auto', cell_selection:'sea',
      current:[
        'ocean_current_velocity','ocean_current_direction',
        'sea_surface_temperature','wave_height','wave_direction',
        'sea_level_height_msl'
      ].join(','),
      hourly:['sea_level_height_msl'].join(',')
    });

    const mRes=await fetch(urlMarine).then(r=>r.json());

    /* ====== 浪況卡 ====== */
    const cur=mRes.current||{};
    const curKmh=(cur.ocean_current_velocity??0);
    const curMsVal=curKmh*1000/3600;
    document.getElementById('wave-current').textContent=curMsVal.toFixed(1);

    const sst=cur.sea_surface_temperature;
    if(sst!=null)document.getElementById('sea-temp').textContent=Math.round(sst);
    document.getElementById('current-speed').textContent=curMsVal.toFixed(1);

    const wdir=cur.wave_direction??0;
    document.getElementById('wave-dir').textContent=`${Math.round(wdir)}° ${degToCompass(wdir)}`;

    const waveH = cur.wave_height;
    document.getElementById('wave-hint').textContent = waveHintByHeight(waveH);

    /* ====== 潮汐卡 ====== */
    const tideNow = cur.sea_level_height_msl;
    if (tideNow != null){
      document.getElementById('tide-current').textContent = tideNow.toFixed(2);
    }

    const times = (mRes.hourly?.time||[]).map(t=>new Date(t));
    const heights = mRes.hourly?.sea_level_height_msl||[];

    const fmtHM = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    if (times.length > 2 && heights.length === times.length){
      const now = new Date();
      let idx = times.findIndex(t=>t > now);
      if (idx === -1) idx = times.length - 1;
      else if (idx > 0) idx -= 1;
      idx = Math.max(1, Math.min(idx, heights.length-2));

      const rising = heights[idx+1] > heights[idx] + 1e-6;
      const falling = heights[idx+1] < heights[idx] - 1e-6;
      const trend = rising ? '（漲潮中）' : (falling ? '（退潮中）' : '（平潮）');

      const nowH = (tideNow!=null) ? tideNow : heights[idx];
      document.getElementById('tide-hint').textContent = `${tideHintByHeight(nowH)}${trend}`;

      const findNextIdx = (start, cmp) => {
        for (let i=Math.max(1,start); i<heights.length-1; i++){
          if (cmp(heights[i-1], heights[i], heights[i+1])) return i;
        }
        return -1;
      };
      const isMin = (a,b,c)=> a>b && b<c;
      const isMax = (a,b,c)=> a<b && b>c;

      const lowIdx  = findNextIdx(idx, isMin);
      const highIdx = findNextIdx(idx, isMax);

      if (lowIdx !== -1){
        document.getElementById('tide-next-low-time').textContent = fmtHM(times[lowIdx]);
        document.getElementById('tide-next-low-height').textContent = `${heights[lowIdx].toFixed(2)} m`;
      }
      if (highIdx !== -1){
        document.getElementById('tide-next-high-time').textContent = fmtHM(times[highIdx]);
        document.getElementById('tide-next-high-height').textContent = `${heights[highIdx].toFixed(2)} m`;
      }
    }else{
      document.getElementById('tide-hint').textContent = '潮汐資料不足';
    }

    /* ====== 計算並更新 Fish Index ====== */
    const fishIdx=calcFishIndex({
      waveH,
      windKmh:window._weatherCache?.windKmh,
      uvIdx:window._weatherCache?.uv,
      tideH:tideNow
    });
    updateFishDial(86);
    document.getElementById('fish-hint').textContent=fishHintByIndex(86);

  }catch(e){
    document.getElementById('wave-hint').textContent='海況資料取得失敗';
    document.getElementById('tide-hint').textContent='潮汐資料取得失敗';
    console.error('marine error',e);
  }
}

/* ========= 初始化 ========================================================= */
(async()=>{
  const {lat,lon}=await getCoords();
  locText.textContent=await reverseGeocode(lat,lon);
  await loadAll(lat,lon);
  await loadMoonUSNO(lat,lon);   // 初始化月相
})();
</script>
</body>
</html>
